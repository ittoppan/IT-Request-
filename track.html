<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามงานแจ้งซ่อม</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Lightbox2 CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css" rel="stylesheet" />

<!-- Lightbox2 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --secondary-color: #f59e0b;
        }
        
        body {
            font-family: 'Kanit', sans-serif;
            line-height: 1.6;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .status-badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        
        .status-new { @apply bg-blue-100 text-blue-800; }
        .status-pending { @apply bg-orange-100 text-orange-800; }
        .status-in-progress { @apply bg-yellow-100 text-yellow-800; }
        .status-completed { @apply bg-green-100 text-green-800; }
        .status-cancelled { @apply bg-gray-100 text-gray-800; }
        
        .priority-badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        
        .priority-low { @apply bg-gray-100 text-gray-800; }
        .priority-medium { @apply bg-blue-100 text-blue-800; }
        .priority-high { @apply bg-orange-100 text-orange-800; }
        .priority-critical { @apply bg-red-100 text-red-800; }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
      
       
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-rotate 0.75s linear infinite;
        }
        
        @keyframes spinner-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Gallery styles */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .gallery-item {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            aspect-ratio: 1;
        }
        
        .gallery-item:hover {
            transform: scale(1.03);
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        
        .gallery-item .image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 0.5rem;
            font-size: 0.75rem;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .gallery-item:hover .image-overlay {
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-full bg-gradient-to-br from-gray-50 to-gray-100">
    <!-- ส่วนหัวเว็บ -->
    <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex-1">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <button id="backBtn" class="flex items-center px-3 py-2 border border-white/30 rounded-lg hover:bg-white/20 transition-all">
                                <i class="fas fa-arrow-left mr-2"></i>
                                กลับ
                            </button>
                        </div>
                        <div class="md:hidden">
                            <button id="mobileMenuButton" class="p-2 rounded-md hover:bg-white/20">
                                <i class="fas fa-bars"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h1 class="text-3xl font-bold">ระบบติดตามงานแจ้งซ่อม</h1>
                        <p class="mt-2 opacity-90">ตรวจสอบสถานะงานซ่อมได้อย่างรวดเร็วและมีประสิทธิภาพ</p>
                    </div>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-4">
                    <div id="userProfile" class="hidden items-center space-x-2 bg-white/10 rounded-full pl-2 pr-4 py-1">
                        <img id="userAvatar" class="w-8 h-8 rounded-full" src="" alt="รูปโปรไฟล์">
                        <span id="fullName" class="font-medium"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ส่วนเนื้อหาหลัก -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- แท็บประเภทงาน -->
        <div class="flex overflow-x-auto scrollbar-hide mb-6 bg-white rounded-lg shadow">
            <button class="job-type-tab active px-6 py-3 font-medium text-sm whitespace-nowrap" data-type="IT">
                <i class="fas fa-desktop mr-2"></i> งานซ่อม IT
            </button>
            <button class="job-type-tab px-6 py-3 font-medium text-sm whitespace-nowrap" data-type="EN">
                <i class="fas fa-cogs mr-2"></i> งานซ่อมเครื่องจักร
            </button>
        </div>

        <!-- ตัวบ่งชี้การโหลด -->
        <div id="loadingIndicator" class="glass-card flex flex-col items-center justify-center py-12 hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
            <p class="text-gray-700 font-medium">กำลังโหลดข้อมูล...</p>
        </div>

        <!-- พื้นที่เนื้อหาหลัก -->
        <div id="mainContent" class="hidden">
            <!-- ส่วนแดชบอร์ด -->
            <section id="dashboardSection" class="glass-card p-6 mb-8 animate-fade-in">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-chart-pie mr-3 text-blue-500"></i>
                        ภาพรวมงานซ่อม
                    </h2>
                    <div class="text-sm text-gray-500 mt-2 md:mt-0">
                        อัปเดตล่าสุด: <span id="lastUpdatedTime" class="font-semibold">กำลังโหลด...</span>
                    </div>
                </div>

                <!-- การ์ดสถิติ -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div class="stat-card bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" data-status="all">
                        <div class="text-3xl font-bold text-blue-600 mb-1" id="totalJobsCount">0</div>
                        <div class="text-sm text-gray-600">ทั้งหมด</div>
                    </div>
                    <div class="stat-card bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" data-status="new">
                        <div class="text-3xl font-bold text-blue-500 mb-1" id="newJobsCount">0</div>
                        <div class="text-sm text-gray-600">แจ้งซ่อมใหม่</div>
                    </div>
                    <div class="stat-card bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" data-status="pending">
                        <div class="text-3xl font-bold text-orange-500 mb-1" id="pendingJobsCount">0</div>
                        <div class="text-sm text-gray-600">รอดำเนินการ</div>
                    </div>
                    <div class="stat-card bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" data-status="in-progress">
                        <div class="text-3xl font-bold text-yellow-500 mb-1" id="inProgressJobsCount">0</div>
                        <div class="text-sm text-gray-600">กำลังดำเนินการ</div>
                    </div>
                    <div class="stat-card bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" data-status="completed">
                        <div class="text-3xl font-bold text-green-500 mb-1" id="completedJobsCount">0</div>
                        <div class="text-sm text-gray-600">เสร็จสิ้น</div>
                    </div>
                </div>

                <!-- แท็บสถานะ -->
                <div class="flex overflow-x-auto scrollbar-hide border-b border-gray-200">
                    <button class="status-tab active px-4 py-2 font-medium text-sm whitespace-nowrap border-b-2 border-blue-500 text-blue-600" data-status="all">
                        ทั้งหมด
                    </button>
                    <button class="status-tab px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 hover:text-gray-700" data-status="new">
                        แจ้งซ่อมใหม่
                    </button>
                    <button class="status-tab px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 hover:text-gray-700" data-status="pending">
                        รอดำเนินการ
                    </button>
                    <button class="status-tab px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 hover:text-gray-700" data-status="in-progress">
                        กำลังดำเนินการ
                    </button>
                    <button class="status-tab px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 hover:text-gray-700" data-status="completed">
                        เสร็จสิ้น
                    </button>
                </div>
            </section>

            <!-- ส่วนรายการงานและรายละเอียด -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- คอลัมน์รายการงาน -->
                <div class="lg:col-span-2 space-y-4">
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-gray-900">
                                รายการงานซ่อม (<span id="jobCount">0</span>)
                                <span class="text-sm font-normal ml-2" id="currentJobType">(IT)</span>
                            </h2>
                            <button id="refreshBtn" class="text-blue-600 hover:text-blue-800 transition-colors p-2 rounded-full hover:bg-gray-100">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- ช่องค้นหา -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="relative">
                            <input type="text" id="jobSearch" placeholder="ค้นหาจากเลขที่งาน, รายละเอียด..." 
                                   class="w-full px-4 py-3 border-0 focus:ring-2 focus:ring-blue-500 bg-white text-gray-900">
                            <div class="absolute right-3 top-3 text-gray-400">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ตู้แสดงรายการงาน -->
                    <div id="jobsContainer" class="space-y-3"></div>
                    
                    <!-- ไม่พบงานซ่อม -->
                    <div id="noJobsFound" class="glass-card hidden">
                        <div class="text-center p-8">
                            <i class="fas fa-file-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600 font-medium">ไม่พบงานซ่อมในสถานะนี้</p>
                            <p class="text-sm text-gray-500 mt-1">ลองเปลี่ยนสถานะหรือประเภทงานดูนะคะ</p>
                        </div>
                    </div>
                </div>

                <!-- คอลัมน์รายละเอียดงาน -->
                <div class="lg:sticky lg:top-8 h-fit space-y-4">
                    <div id="detailHeader" class="hidden bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <span id="detailJobType" class="text-blue-600">IT</span> - 
                            <span id="detailJobId" class="font-mono"></span>
                        </h3>
                    </div>
                    
                    <!-- สถานะว่างเปล่า -->
                    <div id="emptyDetails" class="glass-card">
                        <div class="text-center p-8">
                            <i class="fas fa-info-circle text-4xl text-blue-400 mb-4"></i>
                            <p class="text-gray-600 font-medium">เลือกงานจากรายการด้านซ้าย</p>
                            <p class="text-sm text-gray-500 mt-1">รายละเอียดงานจะแสดงที่นี่</p>
                        </div>
                    </div>
                    
                    <!-- ตู้แสดงรายละเอียดงาน -->
                    <div id="jobDetailsContainer" class="glass-card hidden animate-fade-in"></div>
                </div>
            </div>
        </div>
    </main>

   

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ค่าคงที่และตัวแปร
            const liffId = '2007374280-GR1Q3YxJ';
            const scriptUrl = 'https://script.google.com/macros/s/AKfycbzBBa2ZL8RMTw0UuNH89U8xYXF5xYRB-ek-ufJGem162kGOb7Fr2XqUfmalWp3q9nXQWA/exec';
            
            // ข้อมูลผู้ใช้
            let userId = '';
            let userDisplayName = '';
            let userPictureUrl = '';
        

           

            
            // ข้อมูลงานซ่อม
            let repairJobs = { IT: [], EN: [] };
            let filteredJobs = [];
            let selectedJobId = null;
            let currentStatusFilter = 'all';
            let currentJobType = 'IT';

           

            // องค์ประกอบ DOM
            const loadingIndicator = document.getElementById('loadingIndicator');
            const mainContent = document.getElementById('mainContent');
            const jobsContainer = document.getElementById('jobsContainer');
            const noJobsFound = document.getElementById('noJobsFound');
            const jobDetailsContainer = document.getElementById('jobDetailsContainer');
            const emptyDetails = document.getElementById('emptyDetails');
            const detailHeader = document.getElementById('detailHeader');
            const jobSearch = document.getElementById('jobSearch');
            const refreshBtn = document.getElementById('refreshBtn');
            const backBtn = document.getElementById('backBtn');
            const userProfile = document.getElementById('userProfile');
            const userAvatar = document.getElementById('userAvatar');
            const fullNameSpan = document.getElementById('fullName');
            const statCards = document.querySelectorAll('.stat-card');
            const statusTabs = document.querySelectorAll('.status-tab');
            const jobTypeTabs = document.querySelectorAll('.job-type-tab');

            /**
             * เริ่มต้น LIFF แอปพลิเคชัน
             */
           async function initializeLiff() {
    try {
        await liff.init({ liffId });

        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }

        const profile = await liff.getProfile();
        userId = profile.userId;
        userDisplayName = profile.displayName;
        userPictureUrl = profile.pictureUrl || '';

        // แสดงข้อมูลผู้ใช้
        if (userPictureUrl) {
            userAvatar.src = userPictureUrl;
            userAvatar.alt = userDisplayName;
        }
        fullNameSpan.textContent = userDisplayName; // <<< แก้ไขจุดที่ 1: เปลี่ยน userName เป็น fullNameSpan
        userProfile.classList.remove('hidden');

        await loadRepairJobs();

        // หลังจากโหลดงานซ่อมเสร็จแล้ว ให้อัพเดตชื่อด้วยชื่อจริงจากชีท
        let realFullName = userDisplayName; // ตั้งต้นด้วยชื่อ LINE

        if (repairJobs.IT.length > 0 && repairJobs.IT[0].fullName) {
            realFullName = repairJobs.IT[0].fullName;
        } else if (repairJobs.EN.length > 0 && repairJobs.EN[0].fullName) {
            realFullName = repairJobs.EN[0].fullName;
        }

        fullNameSpan.textContent = realFullName; // <<< แก้ไขจุดที่ 2: เปลี่ยน userName เป็น fullNameSpan
        console.log("ชื่อที่แสดงใน UI:", realFullName);

    } catch (error) {
        console.error('LIFF initialization failed:', error);
        // ตรวจสอบให้แน่ใจว่าฟังก์ชัน showError ถูกกำหนดและสามารถเข้าถึงได้
        showError('เกิดข้อผิดพลาดในการเชื่อมต่อ LINE LIFF', error.message);
    } finally {
        // ตรวจสอบให้แน่ใจว่า loadingIndicator และ mainContent เป็น Element ที่ระบุถูกต้อง
        if (loadingIndicator && mainContent) {
            loadingIndicator.classList.add('hidden');
            mainContent.classList.remove('hidden');
        } else {
            console.warn("ไม่พบ Element ตัวบ่งชี้การโหลด หรือเนื้อหาหลัก");
        }
    }
}

        // === จุดเริ่มต้นการทำงานของ JavaScript: เมื่อ DOM โหลดเสร็จสมบูรณ์ ===
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM fully loaded and parsed. Initializing LIFF...");
            await initializeLiff();
        });

        // เพิ่มฟังก์ชัน showError (ถ้ายังไม่มี)
        function showError(title, message) {
            console.error(title, message);
            alert(`${title}\n${message}`); // ตัวอย่างการแสดง alert ง่ายๆ
        }

        // เพิ่มฟังก์ชัน toArray (ถ้ายังไม่มี)
        function toArray(input) {
            if (!input) return [];
            if (Array.isArray(input)) return input;
            if (typeof input === 'string') return input.split(',').map(s => s.trim()).filter(Boolean);
            return [];
        }
            
            /**
             * แสดงข้อความผิดพลาด
             */
            function showError(title, message) {
                loadingIndicator.innerHTML = `
                    <div class="text-center p-6">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                        <h3 class="mt-3 text-lg font-medium text-gray-900">${title}</h3>
                        <div class="mt-2 text-sm text-gray-500">
                            ${message || 'กรุณาลองใหม่อีกครั้ง'}
                        </div>
                        <div class="mt-5">
                            <button onclick="window.location.reload()" 
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-sync-alt mr-2"></i> ลองใหม่
                            </button>
                        </div>
                    </div>
                `;
                loadingIndicator.classList.remove('hidden');
                mainContent.classList.add('hidden');
            }
            
            /**
             * แสดงการแจ้งเตือนด้วย SweetAlert2
             */
            function showAlert(icon, title, text, confirmButtonText = 'ตกลง') {
                return Swal.fire({
                    icon,
                    title,
                    text,
                    confirmButtonText,
                    confirmButtonColor: '#3B82F6',
                });
            }
            
            /**
             * โหลดข้อมูลงานซ่อม
             */
            async function loadRepairJobs() {
  function toArray(input) {
    if (!input) return [];
    if (Array.isArray(input)) return input;
    if (typeof input === 'string') return input.split(',').map(s => s.trim()).filter(Boolean);
    return [];
  }

  try {
    if (!userId) {
      throw new Error('ไม่พบข้อมูลผู้ใช้');
    }
    
    loadingIndicator.classList.remove('hidden');
    mainContent.classList.add('hidden');
    
    const timestamp = new Date().getTime();
    const [itResponse, enResponse] = await Promise.all([
      fetch(`${scriptUrl}?action=getRepairJobs&userId=${encodeURIComponent(userId)}&formType=IT&t=${timestamp}`),
      fetch(`${scriptUrl}?action=getRepairJobs&userId=${encodeURIComponent(userId)}&formType=EN&t=${timestamp}`)
    ]);
    
    if (!itResponse.ok || !enResponse.ok) {
      throw new Error(`การเชื่อมต่อกับเซิร์ฟเวอร์มีปัญหา: ${itResponse.status}`);
    }
    
    const [itData, enData] = await Promise.all([
      itResponse.json(),
      enResponse.json()
    ]);
    
    if (itData.status === 'error' || enData.status === 'error') {
      throw new Error(itData.message || enData.message || 'เกิดข้อผิดพลาดในการดึงข้อมูล');
    }
    
    // Process IT jobs
    repairJobs.IT = (itData.data || []).map(job => {
      return {
        ...job,
        imageUrls: toArray(job.imageViewerUrls),
        driveUrls: toArray(job.googleDriveUrls)
      };
    });
    
    // Process EN jobs
    repairJobs.EN = (enData.data || []).map(job => {
      return {
        ...job,
        imageUrls: [
          job.photo1,
          job.photo2,
          job.photo3
        ].filter(url => url && url.trim() !== '')
      };
    });
                    
                    updateDashboardStats();
                    filterJobsByType(currentJobType);
                    
                    loadingIndicator.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    
                    document.getElementById('lastUpdatedTime').textContent = new Date().toLocaleString('th-TH', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                } catch (error) {
                    console.error('Error loading repair jobs:', error);
                    showError('โหลดข้อมูลงานซ่อมไม่สำเร็จ', error.message || 'กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');
                }
            }
            
            /**
             * อัปเดตสถิติแดชบอร์ด
             */
            function updateDashboardStats() {
                const jobs = repairJobs[currentJobType];
                const totalJobs = jobs.length;
                const newJobs = jobs.filter(job => job.status === 'แจ้งซ่อมใหม่').length;
                const pendingJobs = jobs.filter(job => job.status === 'รอดำเนินการ').length;
                const inProgressJobs = jobs.filter(job => job.status === 'กำลังดำเนินการ').length;
                const completedJobs = jobs.filter(job => job.status === 'เสร็จสิ้น').length;
                
                document.getElementById('totalJobsCount').textContent = totalJobs;
                document.getElementById('newJobsCount').textContent = newJobs;
                document.getElementById('pendingJobsCount').textContent = pendingJobs;
                document.getElementById('inProgressJobsCount').textContent = inProgressJobs;
                document.getElementById('completedJobsCount').textContent = completedJobs;
            }
            
            /**
             * กรองงานตามประเภท
             */
            function filterJobsByType(type) {
                currentJobType = type;
                document.getElementById('currentJobType').textContent = `(${type})`;
                
                jobTypeTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.type === type);
                });
                
                filterJobsByStatus(currentStatusFilter);
                updateDashboardStats();
            }
            
            /**
             * กรองงานตามสถานะ
             */
            function filterJobsByStatus(status) {
                currentStatusFilter = status;
                
                statusTabs.forEach(tab => {
                    tab.classList.toggle('border-blue-500', tab.dataset.status === status);
                    tab.classList.toggle('text-blue-600', tab.dataset.status === status);
                    tab.classList.toggle('text-gray-500', tab.dataset.status !== status);
                });
                
                let jobs = [...repairJobs[currentJobType]];
                
                switch(status) {
                    case 'new':
                        jobs = jobs.filter(job => job.status === 'แจ้งซ่อมใหม่');
                        break;
                    case 'pending':
                        jobs = jobs.filter(job => job.status === 'รอดำเนินการ');
                        break;
                    case 'in-progress':
                        jobs = jobs.filter(job => job.status === 'กำลังดำเนินการ');
                        break;
                    case 'completed':
                        jobs = jobs.filter(job => job.status === 'เสร็จสิ้น');
                        break;
                }
                
                filteredJobs = jobs;
                renderJobList();
                
                if (selectedJobId && !filteredJobs.some(job => job.jobId === selectedJobId)) {
                    selectedJobId = null;
                    jobDetailsContainer.classList.add('hidden');
                    emptyDetails.classList.remove('hidden');
                    detailHeader.classList.add('hidden');
                }
                
                checkNoJobsFound();
            }
            
            /**
             * ตรวจสอบว่ามีงานที่พบหรือไม่
             */
            function checkNoJobsFound() {
                const hasJobs = filteredJobs.length > 0;
                noJobsFound.classList.toggle('hidden', hasJobs);
                jobsContainer.classList.toggle('hidden', !hasJobs);
            }
            
            /**
             * แสดงรายการงานซ่อม
             */
            function renderJobList() {
                jobsContainer.innerHTML = '';
                document.getElementById('jobCount').textContent = filteredJobs.length;
                
                if (filteredJobs.length === 0) {
                    checkNoJobsFound();
                    return;
                }
                
                filteredJobs.forEach((job, index) => {
                    const jobCard = document.createElement('div');
                    jobCard.className = `bg-white rounded-lg shadow overflow-hidden cursor-pointer transition-all duration-200 hover:shadow-md ${selectedJobId === job.jobId ? 'ring-2 ring-blue-500' : ''}`;
                    jobCard.id = `job-${job.jobId}`;
                    jobCard.onclick = () => selectJob(job.jobId);
                    
                    const statusInfo = getStatusInfo(job.status);
                    const priorityInfo = getPriorityInfo(job.urgency);
                    const problemInfo = currentJobType === 'IT' 
                        ? job.problemType || 'ไม่ระบุประเภทปัญหา'
                        : job.machineName ? `${job.machineName} (${job.jobType || 'ไม่ระบุ'})` : job.jobType || 'ไม่ระบุประเภทงาน';
                    
                    jobCard.innerHTML = `
                        <div class="p-4">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-lg font-semibold text-gray-900 truncate">${job.jobId || 'N/A'}</h3>
                                    <p class="text-sm text-gray-600 mt-1 truncate">${problemInfo}</p>
                                </div>
                                <div class="ml-4 flex flex-col items-end">
                                    <span class="${statusInfo.class} mb-1">
                                        <i class="${statusInfo.icon} mr-1"></i>
                                        ${statusInfo.text}
                                    </span>
                                    ${priorityInfo ? `
                                        <span class="${priorityInfo.class}">
                                            ${priorityInfo.text}
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div class="mt-4 flex items-center justify-between text-sm text-gray-500">
                                <div class="flex items-center">
                                    <i class="fas fa-user-circle mr-2"></i>
                                    <span>${job.fullName || 'ไม่ระบุชื่อ'}</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-calendar-alt mr-2"></i>
                                    <span>${formatDate(job.timestamp)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    jobsContainer.appendChild(jobCard);
                });
            }
            
            /**
             * เลือกงานเพื่อดูรายละเอียด
             */
            function selectJob(jobId) {
                const selectedJob = filteredJobs.find(job => job.jobId === jobId);
                if (!selectedJob) return;
                
                document.querySelectorAll('#jobsContainer > div').forEach(card => {
                    card.classList.remove('ring-2', 'ring-blue-500');
                });
                
                const currentSelectedCard = document.getElementById(`job-${jobId}`);
                if (currentSelectedCard) {
                    currentSelectedCard.classList.add('ring-2', 'ring-blue-500');
                }

                selectedJobId = jobId;
                renderJobDetails(selectedJob);
            }
            
            /**
             * แสดงรายละเอียดงาน
             */
            function renderJobDetails(job) {
                emptyDetails.classList.add('hidden');
                detailHeader.classList.remove('hidden');
                jobDetailsContainer.classList.remove('hidden');
                
                document.getElementById('detailJobType').textContent = currentJobType;
                document.getElementById('detailJobId').textContent = job.jobId || 'N/A';
                
                jobDetailsContainer.innerHTML = `
                    <div class="p-6 space-y-6">
                        ${createStatusSummaryHtml(job)}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-lg shadow">
                                <p class="text-sm text-gray-500 mb-2">ผู้แจ้งซ่อม</p>
                                <p class="font-medium text-gray-900">${job.fullName || 'ไม่ระบุ'}</p>
                                <p class="text-sm text-gray-600">${job.department || 'ไม่ระบุแผนก'}</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow">
                                <p class="text-sm text-gray-500 mb-2">วันที่แจ้งซ่อม</p>
                                <p class="font-medium text-gray-900">${formatThaiDate(job.timestamp)}</p>
                            </div>
                        </div>
                        
                        ${createTypeSpecificHtml(job)}
                        
                        ${createImageGalleryHtml(job)}
                        
                        ${createProgressNotesHtml(job)}
                        
                        ${job.additionalNotes ? `
                            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                <h4 class="font-semibold text-yellow-800 mb-2">หมายเหตุเพิ่มเติม</h4>
                                <p class="text-sm text-yellow-700">${job.additionalNotes}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            /**
             * สร้าง HTML สำหรับสรุปสถานะงาน
             */
            function createStatusSummaryHtml(job) {
                const statusInfo = getStatusInfo(job.status);
                const priorityInfo = getPriorityInfo(job.urgency || job.priority);
                
                return `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <p class="text-sm text-gray-500 mb-1">สถานะงาน</p>
                            <div class="flex items-center">
                                <i class="${statusInfo.icon} mr-2 text-${statusInfo.color}-500"></i>
                                <span class="font-medium text-gray-900">${statusInfo.text}</span>
                            </div>
                        </div>
                        ${priorityInfo ? `
                            <div class="bg-white p-4 rounded-lg shadow">
                                <p class="text-sm text-gray-500 mb-1">ความเร่งด่วน</p>
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-circle mr-2 text-${priorityInfo.color}-500"></i>
                                    <span class="font-medium text-gray-900">${priorityInfo.text}</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            /**
             * สร้าง HTML สำหรับข้อมูลเฉพาะประเภทงาน
             */
            function createTypeSpecificHtml(job) {
                if (currentJobType === 'IT') {
                    return `
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">ข้อมูลปัญหา</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">ประเภทปัญหา</p>
                                    <p class="text-gray-900">${job.problemType || 'ไม่ระบุ'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">อุปกรณ์</p>
                                    <p class="text-gray-900">${job.device || 'ไม่ระบุ'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">ความเร่งด่วน</p>
                                    <p class="text-gray-900">${job.urgency || 'ไม่ระบุ'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">สำนักงาน</p>
                                    <p class="text-gray-900">${job.office || 'ไม่ระบุ'}</p>
                                </div>
                            </div>
                            <div class="mt-4">
                                <p class="text-sm text-gray-500">รายละเอียดปัญหา</p>
                                <p class="text-gray-900 mt-1">${job.problemDetails || 'ไม่มีรายละเอียดเพิ่มเติม'}</p>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">ข้อมูลเครื่องจักร</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">ชื่อเครื่องจักร</p>
                                        <p class="text-gray-900">${job.machineName || 'ไม่ระบุ'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">รหัสเครื่องจักร</p>
                                        <p class="text-gray-900">${job.machineCode || 'ไม่ระบุ'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">สถานที่ตั้ง</p>
                                        <p class="text-gray-900">${job.machineLocation || 'ไม่ระบุ'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">ประเภทงาน</p>
                                        <p class="text-gray-900">${job.jobType || 'ไม่ระบุ'}</p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-500">รายละเอียดปัญหา</p>
                                    <p class="text-gray-900 mt-1">${job.problemDescription || 'ไม่มีรายละเอียด'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-lg shadow en-specific">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">การซ่อมบำรุง</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">ผู้ตรวจพบปัญหา</p>
                                        <p class="text-gray-900">${job.reportedBy || 'ไม่ระบุ'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">วันที่พบปัญหา</p>
                                        <p class="text-gray-900">${formatDate(job.problemDate) || 'ไม่ระบุ'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">สาเหตุ</p>
                                        <p class="text-gray-900">${job.rootCause || 'ยังไม่ทราบสาเหตุ'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">การดำเนินการ</p>
                                        <p class="text-gray-900">${job.maintenanceAction || 'ไม่ระบุ'}</p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-500">รายละเอียดการซ่อม</p>
                                    <p class="text-gray-900 mt-1">${job.maintenanceDescription || 'ไม่มีข้อมูล'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-lg shadow en-specific">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">อะไหล่และวัสดุ</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">อะไหล่ที่ใช้</p>
                                        <p class="text-gray-900">${job.sparePartsUsed || 'ไม่มี'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">จำนวน</p>
                                        <p class="text-gray-900">${job.quantity || '0'} ${job.unit || 'ชิ้น'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">หมายเลขอะไหล่</p>
                                        <p class="text-gray-900">${job.partNumber || 'ไม่ระบุ'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">ค่าใช้จ่าย</p>
                                        <p class="text-gray-900">${job.cost ? '฿' + job.cost : 'ไม่ระบุ'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            /**
             * สร้าง HTML สำหรับแกลเลอรี่รูปภาพ
             */
            function createImageGalleryHtml(job) {
    let imageObjects = [];

    if (currentJobType === 'IT') {
        // ตรวจสอบให้แน่ใจว่า imageViewerUrls ถูกประมวลผลเป็นอาร์เรย์ของสตริง
        const urls = typeof job.imageViewerUrls === 'string'
            ? job.imageViewerUrls.split(',').map(url => url.trim()).filter(Boolean) // เพิ่ม .filter(Boolean) เพื่อลบสตริงว่าง
            : (job.imageViewerUrls || []).filter(Boolean); // ตรวจสอบให้แน่ใจว่าเป็นอาร์เรย์และกรองค่าว่าง/null ออก

        imageObjects = urls.map((url, index) => ({
            url,
            caption: `รูปที่ ${index + 1}`
        }));
    } else {
        // กรอง URL ที่เป็น null/undefined/สตริงว่าง ออกไปทันที
        imageObjects = [
            { url: job.photo2, caption: 'รูปก่อนซ่อม' },
            { url: job.photo3, caption: 'รูปหลังซ่อม' }
        ].filter(obj => obj.url && obj.url.trim() !== ''); // กรอง URL ที่ไม่ถูกต้องออกไป
    }

    if (imageObjects.length === 0) {
        return `
            <div class="bg-white p-6 rounded-lg shadow">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">รูปภาพประกอบ</h4>
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-image text-3xl mb-2"></i>
                    <p>ไม่มีรูปภาพประกอบ</p>
                </div>
            </div>
        `;
    }

    // สร้างชื่อแกลเลอรีที่ไม่ซ้ำกันสำหรับ Lightbox2 โดยอิงจาก jobId
    // สิ่งนี้จะจัดกลุ่มรูปภาพทั้งหมดของงานเดียวให้อยู่ในแกลเลอรี Lightbox เดียวกัน
    const lightboxGalleryName = `job-gallery-${job.jobId || 'unknown'}`;

    return `
        <div class="bg-white p-6 rounded-lg shadow">
            <h4 class="text-lg font-semibold text-gray-900 mb-4">รูปภาพประกอบ (${imageObjects.length})</h4>
            <div class="gallery-grid grid grid-cols-2 md:grid-cols-3 gap-4">
                ${imageObjects.map(img => `
                    <div class="gallery-item"> <a href="${img.url}" data-lightbox="${lightboxGalleryName}" data-title="${img.caption}" class="block w-full h-full">
                            <img src="${img.url}" alt="${img.caption}" class="rounded shadow-md w-full h-auto object-cover" loading="lazy"
                                onerror="this.onerror=null;this.src='https://via.placeholder.com/150?text=Image+Not+Found'">
                            <div class="text-center mt-2 text-sm text-gray-700">${img.caption}</div>
                        </a>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

            
            /**
             * สร้าง HTML สำหรับบันทึกความคืบหน้า
             */
            function createProgressNotesHtml(job) {
                let notes = job.notes || job.maintenanceNote || job.progressNotes || '';
                
                if (currentJobType === 'EN' && job.historyNotes) {
                    notes = job.historyNotes;
                }
                
                if (!notes || notes.length === 0) {
                    return `
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">บันทึกความคืบหน้า</h4>
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-info-circle text-3xl mb-2"></i>
                                <p>ยังไม่มีบันทึกความคืบหน้า</p>
                            </div>
                        </div>
                    `;
                }
                
                const notesArray = typeof notes === 'string' ? notes.split('\n').filter(n => n.trim().length > 0) : notes;
                
                return `
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">บันทึกความคืบหน้า (${notesArray.length})</h4>
                        <div class="space-y-3">
                            ${notesArray.map((note, index) => `
                                <div class="flex items-start space-x-3 p-4 bg-blue-50 rounded-lg border border-blue-100">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                                        <span class="text-blue-600 font-medium text-sm">${index + 1}</span>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm text-gray-800">${note}</p>
                                        ${job.noteDates && job.noteDates[index] ? `
                                            <p class="mt-1 text-xs text-gray-500">
                                                <i class="far fa-clock mr-1"></i>
                                                ${formatDateTime(job.noteDates[index])}
                                            </p>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            /**
             * ข้อมูลสถานะงาน
             */
            function getStatusInfo(status) {
                switch(status) {
                    case 'แจ้งซ่อมใหม่':
                        return { class: 'status-new', icon: 'fas fa-file-circle-plus text-blue-500', text: 'แจ้งซ่อมใหม่', color: 'blue' };
                    case 'รอดำเนินการ':
                        return { class: 'status-pending', icon: 'fas fa-clock text-orange-500', text: 'รอดำเนินการ', color: 'orange' };
                    case 'กำลังดำเนินการ':
                        return { class: 'status-in-progress', icon: 'fas fa-tools text-yellow-500', text: 'กำลังดำเนินการ', color: 'yellow' };
                    case 'เสร็จสิ้น':
                        return { class: 'status-completed', icon: 'fas fa-check-circle text-green-500', text: 'เสร็จสิ้น', color: 'green' };
                    case 'ยกเลิก':
                        return { class: 'status-cancelled', icon: 'fas fa-times-circle text-gray-500', text: 'ยกเลิก', color: 'gray' };
                    default:
                        return { class: 'status-pending', icon: 'fas fa-clock text-gray-500', text: status || 'ไม่ทราบสถานะ', color: 'gray' };
                }
            }
            
            /**
             * ข้อมูลความเร่งด่วน
             */
            function getPriorityInfo(priority) {
                if (!priority) return null;
                
                switch(priority.toLowerCase()) {
                    case 'ต่ำ':
                        return { class: 'priority-low', text: 'ต่ำ', color: 'gray' };
                    case 'ปานกลาง':
                    case 'normal':
                        return { class: 'priority-medium', text: 'ปานกลาง', color: 'blue' };
                    case 'สูง':
                    case 'high':
                        return { class: 'priority-high', text: 'สูง', color: 'orange' };
                    case 'ด่วนมาก':
                    case 'critical':
                        return { class: 'priority-critical', text: 'ด่วนมาก', color: 'red' };
                    default:
                        return { class: 'priority-medium', text: priority, color: 'blue' };
                }
            }
            
            /**
             * จัดรูปแบบวันที่
             */
            function formatDate(dateString) {
                if (!dateString) return 'ไม่ระบุ';
                
                const date = convertGoogleDate(dateString);
                if (isNaN(date.getTime())) return 'ไม่ระบุ';
                
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            /**
             * จัดรูปแบบวันที่ภาษาไทย
             */
           function formatThaiDate(dateString) {
    if (!dateString) return 'ไม่ระบุ';

    const date = convertGoogleDate(dateString);
    if (isNaN(date.getTime())) return 'ไม่ระบุ';

    const thaiMonths = [
        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน',
        'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม',
        'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
    ];

    const day = date.getDate();
    const month = thaiMonths[date.getMonth()];
    const year = date.getFullYear() + 543; // แปลงเป็นปีพุทธศักราช

    // ดึงชั่วโมงและนาทีจริงจากข้อมูล และจัดรูปแบบให้มี 2 หลัก
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');

    // คืนค่าเป็น วัน เดือน ปี ชั่วโมง:นาที น.
    return `${day} ${month} ${year} ${hours}:${minutes} น.`;
}
            
            /**
             * จัดรูปแบบวันที่และเวลา
             */
           function formatDateTime(dateTimeString) {
    if (!dateTimeString) return 'ไม่ระบุ';

    const date = convertGoogleDate(dateTimeString);
    if (isNaN(date.getTime())) return 'ไม่ระบุ';

    return date.toLocaleString('th-TH', {
        year: 'numeric',
        month: 'short', // หรือ 'long' หากต้องการชื่อเดือนเต็ม
        day: 'numeric',
        hour: '2-digit',   // แสดงชั่วโมงแบบ 2 หลัก
        minute: '2-digit', // แสดงนาทีแบบ 2 หลัก
        hour12: false      // ใช้รูปแบบ 24 ชั่วโมง
        // ไม่ได้ระบุ 'second' จึงจะไม่แสดงวินาที
    });
}
            
            /**
             * แปลงรูปแบบวันที่จาก Google Sheets
             */
           /**
 * แปลงรูปแบบวันที่จาก Google Sheets
 */
function convertGoogleDate(dateString) {
    if (!dateString) return new Date(NaN);

    if (typeof dateString === 'number') {
        return new Date(dateString);
    }

    if (typeof dateString === 'string') {
        const isoDateFormat = dateString.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (isoDateFormat) {
            return new Date(Date.UTC(
                parseInt(isoDateFormat[1]),
                parseInt(isoDateFormat[2]) - 1,
                parseInt(isoDateFormat[3])
            ));
        }

        // *** ตรวจสอบว่ามีส่วนนี้อยู่และถูกต้องในโค้ดของคุณ ***
        const dateTimeSlashFormat = dateString.match(/^(\d{2})\/(\d{2})\/(\d{4})\s(\d{2}):(\d{2}):(\d{2})$/);
        if (dateTimeSlashFormat) {
            return new Date(
                parseInt(dateTimeSlashFormat[3]),
                parseInt(dateTimeSlashFormat[2]) - 1,
                parseInt(dateTimeSlashFormat[1]),
                parseInt(dateTimeSlashFormat[4]),
                parseInt(dateTimeSlashFormat[5]),
                parseInt(dateTimeSlashFormat[6])
            );
        }
        // *************************************************

        const slashDateFormat = dateString.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (slashDateFormat) {
            return new Date(
                parseInt(slashDateFormat[3]),
                parseInt(slashDateFormat[2]) - 1,
                parseInt(slashDateFormat[1])
            );
        }

        const parsedDate = new Date(dateString);
        if (!isNaN(parsedDate.getTime())) {
            return parsedDate;
        }
    }
    return new Date(NaN);
}
            
           
            /**
             * ตั้งค่าการค้นหา
             */
            function setupSearch() {
                jobSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    
                    if (searchTerm === '') {
                        filterJobsByStatus(currentStatusFilter);
                        return;
                    }
                    
                    filteredJobs = repairJobs[currentJobType].filter(job => {
                        return (
                            (job.jobId && job.jobId.toLowerCase().includes(searchTerm)) ||
                            (job.problemDetails && job.problemDetails.toLowerCase().includes(searchTerm)) ||
                            (job.problemDescription && job.problemDescription.toLowerCase().includes(searchTerm)) ||
                            (job.machineName && job.machineName.toLowerCase().includes(searchTerm)) ||
                            (job.problemType && job.problemType.toLowerCase().includes(searchTerm)) ||
                            (job.jobType && job.jobType.toLowerCase().includes(searchTerm))
                        );
                    });
                    
                    renderJobList();
                    checkNoJobsFound();
                });
            }
            
            /**
             * กลับไปหน้าก่อนหน้า
             */
            function goBack() {
                if (liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.location.href = 'https://liff.line.me/2007374280-GEYwyNdl';
                }
            }
            
            // ตั้งค่า Event Listeners
            statCards.forEach(card => {
                card.addEventListener('click', function() {
                    filterJobsByStatus(this.dataset.status);
                });
            });
            
            statusTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    filterJobsByStatus(this.dataset.status);
                });
            });
            
            jobTypeTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    filterJobsByType(this.dataset.type);
                });
            });
            
            refreshBtn.addEventListener('click', function() {
                loadRepairJobs();
                showAlert('success', 'กำลังโหลดข้อมูล', 'ระบบกำลังอัปเดตข้อมูลงานซ่อมล่าสุด');
            });
            
            backBtn.addEventListener('click', goBack);
            
            // เปิด Lightbox จาก global scope
            window.openLightbox = openLightbox;
            window.closeLightbox = closeLightbox;
            window.changeLightboxImage = changeLightboxImage;
            
            // เริ่มต้นแอปพลิเคชัน
            window.onload = function() {
                initializeLiff();
                setupSearch();
            };
        });
        
function openModal(imageUrl) {
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  modalImage.src = imageUrl;
  modal.classList.remove('hidden');
}

function closeModal() {
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  modalImage.src = '';
  modal.classList.add('hidden');
}

    </script>
<!-- Modal -->
<div id="imageModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
  <div class="relative max-w-3xl w-full">
    <img id="modalImage" src="" alt="รูปภาพขยาย" class="w-full h-auto rounded-lg shadow-lg">
    <button onclick="closeModal()"
      class="absolute top-2 right-2 bg-white rounded-full p-2 hover:bg-gray-200 focus:outline-none">
      <svg class="h-6 w-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
</div>

</body>
</html>
