<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบติดตามงานแจ้งซ่อม IT</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans Thai', sans-serif;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .header-gradient {
      background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
    }
    .animate-slide-up {
      animation: slideUp 0.5s ease-out;
    }
    .animate-float {
      animation: float 6s ease-in-out infinite;
    }
    .shadow-glow {
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-200">
    <!-- Header -->
    <div class="header-gradient text-white p-6 relative overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-r from-blue-500/90 to-indigo-500/90"></div>
      <div class="floating-shapes absolute inset-0 pointer-events-none">
        <div class="absolute top-10 left-10 w-20 h-20 bg-white/10 rounded-full animate-float"></div>
        <div class="absolute top-32 right-20 w-16 h-16 bg-white/5 rounded-full animate-float" style="animation-delay: 1s"></div>
        <div class="absolute bottom-20 left-1/3 w-12 h-12 bg-white/5 rounded-full animate-float" style="animation-delay: 2s"></div>
      </div>
      
      <div class="relative z-10 max-w-6xl mx-auto">
        <div class="flex items-center gap-4 mb-4">
          <a href="/">
            <button class="flex items-center px-3 py-1.5 text-sm text-white border border-white/30 rounded-md hover:bg-white/20">
              <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
              กลับ
            </button>
          </a>
        </div>
        <h1 class="text-3xl font-semibold mb-2">ติดตามงานแจ้งซ่อม IT</h1>
        <p class="opacity-90">ตรวจสอบสถานะงานซ่อมของคุณได้ที่นี่</p>
      </div>
    </div>

    <div class="max-w-6xl mx-auto p-6 -mt-8 relative z-10">
      <!-- Search Section -->
      <div class="glass-card mb-8 rounded-lg shadow-md animate-slide-up">
        <div class="p-6">
          <div class="flex items-center mb-4">
            <i data-lucide="search" class="w-5 h-5 mr-2"></i>
            <h2 class="text-lg font-semibold">ค้นหางานซ่อม</h2>
          </div>
          <div class="flex gap-4">
            <input
              type="text"
              placeholder="ใส่เลขที่งาน, ชื่อผู้แจ้ง หรือรายละเอียดงาน..."
              id="searchInput"
              class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeypress="if(event.key === 'Enter') handleSearch()"
            />
            <button onclick="handleSearch()" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
              <i data-lucide="search" class="w-4 h-4 mr-2"></i>
              ค้นหา
            </button>
          </div>
        </div>
      </div>

      <!-- Jobs List -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Jobs Grid -->
        <div class="space-y-4">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">
            รายการงานซ่อม (<span id="jobCount">0</span> งาน)
          </h2>
          
          <!-- Job Cards will be inserted here by JavaScript -->
          <div id="jobList"></div>
          
          <div id="loadingIndicator" class="glass-card rounded-lg shadow-md">
            <div class="text-center py-8">
              <i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 mb-4 animate-spin"></i>
              <p class="text-gray-500">กำลังโหลดข้อมูล...</p>
            </div>
          </div>
          
          <div id="noResults" class="glass-card rounded-lg shadow-md hidden">
            <div class="text-center py-8">
              <i data-lucide="search" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
              <p class="text-gray-500">ไม่พบงานที่ตรงกับการค้นหา</p>
            </div>
          </div>
        </div>

        <!-- Job Details -->
        <div class="lg:sticky lg:top-6">
          <div id="jobDetailsPlaceholder" class="glass-card rounded-lg shadow-md">
            <div class="text-center py-12">
              <i data-lucide="file-text" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
              <p class="text-gray-500">เลือกงานจากรายการเพื่อดูรายละเอียด</p>
            </div>
          </div>
          
          <div id="jobDetails" class="glass-card rounded-lg shadow-md hidden animate-fade-in">
            <!-- Job details will be inserted here by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ข้อมูลงานซ่อม
    let jobs = [];
    let filteredJobs = [];
    let selectedJob = null;

    const statusConfig = {
      'แจ้งซ่อมใหม่': { label: 'แจ้งซ่อมใหม่', icon: 'clock', color: 'bg-yellow-500' },
      'กำลังดำเนินการ': { label: 'กำลังดำเนินการ', icon: 'alert-circle', color: 'bg-blue-500' },
      'เสร็จสิ้น': { label: 'เสร็จสิ้น', icon: 'check-circle', color: 'bg-green-500' },
      'ยกเลิก': { label: 'ยกเลิก', icon: 'x-circle', color: 'bg-red-500' }
    };

    const priorityConfig = {
      'ปกติ': 'bg-gray-500',
      'ด่วน': 'bg-yellow-500',
      'ด่วนมาก': 'bg-orange-500',
      'วิกฤต': 'bg-red-500'
    };

    // เมื่อหน้าเว็บโหลดเสร็จ
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      fetchRepairJobs();
    });

    // ดึงข้อมูลงานซ่อมจาก Google Sheets
    function fetchRepairJobs() {
      document.getElementById('loadingIndicator').classList.remove('hidden');
      
      // เรียกใช้ Google Apps Script API
      google.script.run
        .withSuccessHandler(handleJobsData)
        .withFailureHandler(handleError)
        .getRepairJobs({ action: 'getRepairJobs' });
    }

    function handleJobsData(response) {
      document.getElementById('loadingIndicator').classList.add('hidden');
      
      if (response.status === 'success') {
        jobs = response.data.map(job => {
          // แปลงข้อมูลจาก Google Sheet ให้ตรงกับโครงสร้างที่ต้องการ
          return {
            id: job['Timestamp'],
            jobId: job['เลขที่งานแจ้งซ่อม'],
            title: job['ประเภทปัญหา'],
            description: job['รายละเอียดปัญหา'],
            status: job['สถานะ'] || 'แจ้งซ่อมใหม่',
            priority: job['ความเร่งด่วน'] || 'ปกติ',
            requester: job['ชื่อ-นามสกุล'],
            department: job['แผนก/สำนัก'],
            office: job['สถานที่'],
            phone: job['เบอร์โทรศัพท์'],
            email: job['อีเมล์'],
            createdAt: job['Timestamp'],
            updatedAt: job['Timestamp'], // ในกรณีจริงควรมีคอลัมน์วันที่อัพเดทแยกต่างหาก
            images: job['Image Viewer URLs'] ? job['Image Viewer URLs'].split(', ') : []
          };
        });
        
        // เรียงลำดับตามวันที่ล่าสุด
        jobs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        filteredJobs = [...jobs];
        document.getElementById('jobCount').textContent = filteredJobs.length;
        renderJobList();
        
        if (filteredJobs.length > 0) {
          selectJob(filteredJobs[0]);
        }
      } else {
        showToast('เกิดข้อผิดพลาด', response.message, 'error');
      }
    }

    function handleError(error) {
      document.getElementById('loadingIndicator').classList.add('hidden');
      console.error('Error fetching jobs:', error);
      showToast('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลได้', 'error');
    }

    // จัดรูปแบบวันที่
    function formatDate(dateString) {
      if (!dateString) return 'ไม่ระบุ';
      
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return 'ไม่ระบุ';
      
      const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      return date.toLocaleDateString('th-TH', options);
    }

    // การค้นหา
    function handleSearch() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      if (!searchTerm.trim()) {
        filteredJobs = [...jobs];
      } else {
        filteredJobs = jobs.filter(job =>
          (job.jobId && job.jobId.toLowerCase().includes(searchTerm)) ||
          (job.requester && job.requester.toLowerCase().includes(searchTerm)) ||
          (job.title && job.title.toLowerCase().includes(searchTerm)) ||
          (job.description && job.description.toLowerCase().includes(searchTerm))
        );
      }

      document.getElementById('jobCount').textContent = filteredJobs.length;
      renderJobList();

      if (filteredJobs.length === 0) {
        document.getElementById('noResults').classList.remove('hidden');
      } else {
        document.getElementById('noResults').classList.add('hidden');
        if (filteredJobs.length > 0) {
          selectJob(filteredJobs[0]);
        } else {
          document.getElementById('jobDetails').classList.add('hidden');
          document.getElementById('jobDetailsPlaceholder').classList.remove('hidden');
        }
      }
    }

    // แสดงรายการงาน
    function renderJobList() {
      const jobListElement = document.getElementById('jobList');
      jobListElement.innerHTML = '';

      filteredJobs.forEach((job, index) => {
        const statusInfo = statusConfig[job.status] || statusConfig['แจ้งซ่อมใหม่'];
        const priority = priorityConfig[job.priority] || priorityConfig['ปกติ'];
        
        const jobCard = document.createElement('div');
        jobCard.className = `glass-card cursor-pointer transition-all duration-300 hover:shadow-lg hover:scale-[1.02] rounded-lg shadow-md overflow-hidden ${selectedJob?.id === job.id ? 'ring-2 ring-blue-500 shadow-glow' : ''}`;
        jobCard.style.animationDelay = `${index * 100}ms`;
        jobCard.onclick = () => selectJob(job);
        
        jobCard.innerHTML = `
          <div class="p-4">
            <div class="flex items-start justify-between mb-3">
              <div>
                <h3 class="font-semibold text-gray-800 text-lg">${job.jobId || 'ไม่มีเลขที่งาน'}</h3>
                <p class="text-gray-600">${job.title || 'ไม่มีชื่อปัญหา'}</p>
              </div>
              <div class="flex flex-col items-end gap-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white ${statusInfo.color}">
                  <i data-lucide="${statusInfo.icon}" class="w-3 h-3 mr-1"></i>
                  ${statusInfo.label}
                </span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white ${priority}">
                  ${job.priority || 'ปกติ'}
                </span>
              </div>
            </div>
            
            <div class="space-y-2 text-sm">
              <div class="flex items-center text-gray-600">
                <i data-lucide="user" class="w-4 h-4 mr-2"></i>
                ${job.requester || 'ไม่ระบุ'} - ${job.department || 'ไม่ระบุ'}
              </div>
              <div class="flex items-center text-gray-600">
                <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
                ${formatDate(job.createdAt)}
              </div>
            </div>
          </div>
        `;
        
        jobListElement.appendChild(jobCard);
        lucide.createIcons();
      });
    }

    // เลือกงานเพื่อแสดงรายละเอียด
    function selectJob(job) {
      selectedJob = job;
      renderJobList();
      renderJobDetails();
    }

    // แสดงรายละเอียดงาน
    function renderJobDetails() {
      const jobDetailsElement = document.getElementById('jobDetails');
      const placeholderElement = document.getElementById('jobDetailsPlaceholder');
      
      placeholderElement.classList.add('hidden');
      jobDetailsElement.classList.remove('hidden');
      
      const statusInfo = statusConfig[selectedJob.status] || statusConfig['แจ้งซ่อมใหม่'];
      const priority = priorityConfig[selectedJob.priority] || priorityConfig['ปกติ'];
      
      jobDetailsElement.innerHTML = `
        <div class="p-6">
          <div class="flex items-center mb-4">
            <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
            <h2 class="text-lg font-semibold">รายละเอียดงาน ${selectedJob.jobId || 'ไม่มีเลขที่งาน'}</h2>
          </div>
          
          <div class="space-y-6">
            <!-- Status -->
            <div class="p-4 bg-gray-100/50 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium">สถานะปัจจุบัน</span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white ${statusInfo.color}">
                  <i data-lucide="${statusInfo.icon}" class="w-3 h-3 mr-1"></i>
                  ${statusInfo.label}
                </span>
              </div>
              <div class="flex items-center justify-between mt-2">
                <span class="font-medium">ความเร่งด่วน</span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white ${priority}">
                  ${selectedJob.priority || 'ปกติ'}
                </span>
              </div>
            </div>

            <!-- Requester Info -->
            <div>
              <h4 class="font-medium mb-3">ข้อมูลผู้แจ้ง</h4>
              <div class="space-y-2 text-sm">
                <div class="flex items-center">
                  <i data-lucide="user" class="w-4 h-4 mr-2 text-gray-600"></i>
                  ${selectedJob.requester || 'ไม่ระบุ'}
                </div>
                <div class="flex items-center">
                  <i data-lucide="phone" class="w-4 h-4 mr-2 text-gray-600"></i>
                  ${selectedJob.phone || 'ไม่ระบุ'}
                </div>
                <div class="flex items-center">
                  <i data-lucide="mail" class="w-4 h-4 mr-2 text-gray-600"></i>
                  ${selectedJob.email || 'ไม่ระบุ'}
                </div>
                <p class="text-gray-600">${selectedJob.department || 'ไม่ระบุ'} - ${selectedJob.office || 'ไม่ระบุ'}</p>
              </div>
            </div>

            <!-- Problem Details -->
            <div>
              <h4 class="font-medium mb-3">รายละเอียดปัญหา</h4>
              <div class="p-3 bg-gray-100/30 rounded-lg">
                <p class="text-sm font-medium text-blue-600 mb-1">${selectedJob.title || 'ไม่มีชื่อปัญหา'}</p>
                <p class="text-sm text-gray-600">${selectedJob.description || 'ไม่มีรายละเอียด'}</p>
              </div>
            </div>

            <!-- Images -->
            ${selectedJob.images && selectedJob.images.length > 0 ? `
              <div>
                <h4 class="font-medium mb-3">รูปภาพประกอบ</h4>
                <div class="grid grid-cols-2 gap-2">
                  ${selectedJob.images.map(imageUrl => `
                    <a href="${imageUrl}" target="_blank" class="block">
                      <img src="${imageUrl}" alt="รูปภาพประกอบ" class="w-full h-auto rounded-md border border-gray-200">
                    </a>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <!-- Timeline -->
            <div>
              <h4 class="font-medium mb-3">เวลา</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">วันที่แจ้ง:</span>
                  <span>${formatDate(selectedJob.createdAt)}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      lucide.createIcons();
    }

    // แสดง Toast Notification
    function showToast(title, description, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg text-white ${
        type === 'error' ? 'bg-red-500' : 'bg-green-500'
      }`;
      toast.innerHTML = `
        <div class="flex items-center">
          <i data-lucide="${type === 'error' ? 'alert-triangle' : 'check-circle'}" class="w-5 h-5 mr-2"></i>
          <div>
            <p class="font-medium">${title}</p>
            <p class="text-sm opacity-90">${description}</p>
          </div>
        </div>
      `;
      
      document.body.appendChild(toast);
      lucide.createIcons();
      
      setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
