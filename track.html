<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ติดตามงานแจ้งซ่อม (เฉพาะของฉัน)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    /* ---- ค่าคงที่ ---- */
    const LIFF_ID = '2007374280-GR1Q3YxJ';                 // <-- แก้เป็น LIFF คุณ
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzBBa2ZL8RMTw0UuNH89U8xYXF5xYRB-ek-ufJGem162kGOb7Fr2XqUfmalWp3q9nXQWA/exec';

    let userId = '';
    let currentType = 'IT';
    let currentStatus = 'all';
    let jobs = [];          // งานทั้งหมดของผู้ใช้
    let filteredJobs = [];  // งานที่ผ่านการกรองแล้ว
  </script>
  <style>body{font-family:'Kanit',sans-serif;}</style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 shadow flex justify-between items-center">
    <h1 class="text-xl font-semibold">ติดตามงานแจ้งซ่อม</h1>
    <button id="backBtn" class="text-sm bg-white/20 px-3 py-1 rounded"><i class="fas fa-arrow-left mr-1"></i> กลับ</button>
  </header>

  <!-- Main -->
  <main class="max-w-4xl mx-auto p-4 space-y-4">
    <!-- เลือกประเภท -->
    <div class="flex gap-2">
      <button data-type="IT" id="tabIT" class="typeTab flex-1 py-2 rounded bg-blue-600 text-white font-semibold">IT</button>
      <button data-type="EN" id="tabEN" class="typeTab flex-1 py-2 rounded bg-gray-300 text-gray-700">EN</button>
    </div>

    <!-- สถิติ -->
    <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 text-center">
      <div class="bg-white rounded p-3 shadow"><div id="statAll" class="text-2xl font-bold text-blue-600">0</div><div class="text-xs">ทั้งหมด</div></div>
      <div class="bg-white rounded p-3 shadow"><div id="statNew" class="text-2xl font-bold text-blue-500">0</div><div class="text-xs">ใหม่</div></div>
      <div class="bg-white rounded p-3 shadow"><div id="statPending" class="text-2xl font-bold text-orange-500">0</div><div class="text-xs">รอดำเนินการ</div></div>
      <div class="bg-white rounded p-3 shadow"><div id="statProgress" class="text-2xl font-bold text-yellow-500">0</div><div class="text-xs">กำลังทำ</div></div>
      <div class="bg-white rounded p-3 shadow"><div id="statDone" class="text-2xl font-bold text-green-500">0</div><div class="text-xs">เสร็จ</div></div>
    </div>

    <!-- กรองสถานะ -->
    <div class="flex gap-1 flex-wrap">
      <button data-st="all"   class="statusBtn bg-blue-600 text-white px-3 py-1 rounded text-sm">ทั้งหมด</button>
      <button data-st="new"   class="statusBtn bg-blue-500 text-white px-3 py-1 rounded text-sm">ใหม่</button>
      <button data-st="pending" class="statusBtn bg-orange-500 text-white px-3 py-1 rounded text-sm">รอดำเนินการ</button>
      <button data-st="in-progress" class="statusBtn bg-yellow-500 text-white px-3 py-1 rounded text-sm">กำลังทำ</button>
      <button data-st="completed" class="statusBtn bg-green-500 text-white px-3 py-1 rounded text-sm">เสร็จ</button>
    </div>

    <!-- รายการ -->
    <div class="bg-white rounded shadow p-3">
      <div class="flex justify-between items-center mb-2">
        <span>รายการ (<span id="jobCount">0</span>)</span>
        <button id="refreshBtn" class="text-blue-600"><i class="fas fa-sync-alt"></i></button>
      </div>
      <div id="jobList" class="space-y-3"></div>
      <p id="emptyMsg" class="text-center text-gray-500 py-6 hidden">ไม่พบงาน</p>
    </div>

    <!-- รายละเอียด -->
    <div id="detailBox" class="bg-white rounded shadow p-4 hidden">
      <h3 class="font-semibold mb-2">รายละเอียด <span id="detailJobId"></span></h3>
      <div id="detailContent" class="text-sm space-y-1"></div>
    </div>
  </main>

  <script>
    /* ---------- ฟังก์ชันช่วย ---------- */
    const $ = sel => document.querySelector(sel);
    const formatDate = d => new Date(d).toLocaleDateString('th-TH');
    const statusMap = {
      'แจ้งซ่อมใหม่': { cls:'bg-blue-500', text:'ใหม่' },
      'รอดำเนินการ':   { cls:'bg-orange-500', text:'รอดำเนินการ' },
      'กำลังดำเนินการ':{ cls:'bg-yellow-500', text:'กำลังทำ' },
      'เสร็จสิ้น':      { cls:'bg-green-500', text:'เสร็จ' }
    };

    /* ---------- โหลดข้อมูล ---------- */
    async function loadJobs() {
      $('#loadingIndicator')?.classList?.remove('hidden');
      try {
        const res = await fetch(`${SCRIPT_URL}?action=getRepairJobs&userId=${userId}&formType=${currentType}`);
        const data = await res.json();
        if (data.status === 'success') {
          jobs = data.data;
          filterJobs();
        } else {
          alert(data.message);
        }
      } catch (e) {
        alert('โหลดข้อมูลไม่สำเร็จ');
      }
      $('#loadingIndicator')?.classList?.add('hidden');
    }

    function filterJobs() {
      let list = jobs;
      switch (currentStatus) {
        case 'new':    list = list.filter(j => j.status === 'แจ้งซ่อมใหม่'); break;
        case 'pending':list = list.filter(j => j.status === 'รอดำเนินการ'); break;
        case 'in-progress':list = list.filter(j => j.status === 'กำลังดำเนินการ'); break;
        case 'completed':list = list.filter(j => j.status === 'เสร็จสิ้น'); break;
      }
      filteredJobs = list;
      renderList();
      updateStats();
    }

    function updateStats() {
      const s = {
        all: jobs.length,
        new: jobs.filter(j => j.status === 'แจ้งซ่อมใหม่').length,
        pending: jobs.filter(j => j.status === 'รอดำเนินการ').length,
        progress: jobs.filter(j => j.status === 'กำลังดำเนินการ').length,
        completed: jobs.filter(j => j.status === 'เสร็จสิ้น').length,
      };
      Object.keys(s).forEach(k => $(`#stat${k.charAt(0).toUpperCase()+k.slice(1)}`).textContent = s[k]);
    }

    function renderList() {
      const box = $('#jobList'); box.innerHTML = '';
      $('#jobCount').textContent = filteredJobs.length;
      $('#emptyMsg').classList.toggle('hidden', filteredJobs.length);
      filteredJobs.forEach((j,i)=>{
        const card = document.createElement('div');
        card.className='border rounded-lg p-3 cursor-pointer hover:bg-blue-50';
        card.innerHTML=`
          <div class="flex justify-between items-start">
            <div>
              <div class="font-bold text-blue-700">${j.jobId}</div>
              <div class="text-sm text-gray-600">${j.fullName || ''} (${j.department || ''})</div>
            </div>
            <span class="px-2 py-1 rounded-full text-xs text-white ${statusMap[j.status]?.cls||'bg-gray-400'}">${statusMap[j.status]?.text||j.status}</span>
          </div>
          <div class="text-xs text-gray-500 mt-1">${currentType==='IT'?(j.problemType||'-'):(j.machineName||'-')}</div>
          <div class="text-xs text-gray-400">${formatDate(j.timestamp)}</div>
        `;
        card.onclick = ()=> showDetail(j);
        box.appendChild(card);
      });
    }

    function showDetail(j) {
      $('#detailJobId').textContent = j.jobId;
      $('#detailContent').innerHTML=`
        <p><strong>ผู้แจ้ง:</strong> ${j.fullName || ''} (${j.department || ''})</p>
        <p><strong>สถานะ:</strong> ${j.status}</p>
        <p><strong>วันที่แจ้ง:</strong> ${formatDate(j.timestamp)}</p>
        ${currentType==='IT' ? `
          <p><strong>ประเภทปัญหา:</strong> ${j.problemType || '-'}</p>
          <p><strong>รายละเอียด:</strong> ${j.problemDetails || '-'}</p>
          <p><strong>อุปกรณ์:</strong> ${j.device || '-'}</p>
          ${j.start ? `<p><strong>เริ่ม:</strong> ${formatDate(j.start)}</p>`:''}
          ${j.end ? `<p><strong>เสร็จ:</strong> ${formatDate(j.end)}</p>`:''}
          ${j.time ? `<p><strong>ใช้เวลา:</strong> ${j.time} ชม.</p>`:''}
        ` : `
          <p><strong>เครื่องจักร:</strong> ${j.machineName || '-'}</p>
          <p><strong>ประเภทงาน:</strong> ${j.jobType || '-'}</p>
          <p><strong>ปัญหา:</strong> ${j.problemDescription || '-'}</p>
        `}
      `;
      $('#detailBox').classList.remove('hidden');
    }

    /* ---------- Event ---------- */
    document.addEventListener('click', e=>{
      if(e.target.classList.contains('typeTab')){
        currentType=e.target.dataset.type;
        document.querySelectorAll('.typeTab').forEach(t=>t.className='typeTab flex-1 py-2 rounded bg-gray-300 text-gray-700');
        e.target.className='typeTab flex-1 py-2 rounded bg-blue-600 text-white font-semibold';
        loadJobs();
      }
      if(e.target.classList.contains('statusBtn')){
        currentStatus=e.target.dataset.st;
        document.querySelectorAll('.statusBtn').forEach(b=>b.className='statusBtn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm');
        e.target.className='statusBtn bg-blue-600 text-white px-3 py-1 rounded text-sm';
        filterJobs();
      }
    });
    $('#refreshBtn').onclick = loadJobs;
    $('#backBtn').onclick = ()=> liff.isInClient()?liff.closeWindow():history.back();

    /* ---------- LIFF ---------- */
    async function initLiff(){
      await liff.init({liffId:LIFF_ID});
      if(!liff.isLoggedIn()){liff.login();return;}
      const p=await liff.getProfile();
      userId=p.userId;
      loadJobs();
    }
    window.onload = initLiff;
  </script>
</body>
</html>
