<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามงานแจ้งซ่อม</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --secondary-color: #f59e0b;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
        }
        
        body {
            font-family: 'Kanit', sans-serif;
            line-height: 1.6;
            transition: all 0.3s ease;
        }
        
        .dark {
            background-color: #1a202c;
            color: #f7fafc;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .dark .glass-card {
            background: rgba(26, 32, 44, 0.9);
            border: 1px solid rgba(74, 85, 104, 0.3);
        }
        
        .status-badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        
        .status-new { @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100; }
        .status-pending { @apply bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-100; }
        .status-in-progress { @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100; }
        .status-completed { @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100; }
        .status-cancelled { @apply bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100; }
        
        .priority-badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        
        .priority-low { @apply bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100; }
        .priority-medium { @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100; }
        .priority-high { @apply bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-100; }
        .priority-critical { @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100; }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .file-icon {
            @apply text-4xl;
        }
        
        .pdf-icon { @apply text-red-500; }
        .doc-icon { @apply text-blue-500; }
        .xls-icon { @apply text-green-500; }
        .img-icon { @apply text-purple-500; }
        .file-icon-default { @apply text-gray-400; }
        
        /* Lightbox styles */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
        }
        
        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            transform: translateY(-50%);
            z-index: 1001;
        }
        
        .lightbox-nav button {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .lightbox-nav button:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
        }
        
        .lightbox-close:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .lightbox-caption {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-rotate 0.75s linear infinite;
        }
        
        @keyframes spinner-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-full bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900">
    <!-- Header Section -->
    <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex-1">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <button id="backBtn" class="flex items-center px-3 py-2 border border-white/30 rounded-lg hover:bg-white/20 transition-all">
                                <i class="fas fa-arrow-left mr-2"></i>
                                กลับ
                            </button>
                            <button id="themeToggle" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                                <i class="fas fa-moon dark:hidden"></i>
                                <i class="fas fa-sun hidden dark:inline"></i>
                            </button>
                        </div>
                 
                    </div>
                    <div class="mt-4">
                        <h1 class="text-3xl font-bold">ระบบติดตามงานแจ้งซ่อม</h1>
                        <p class="mt-2 opacity-90">ตรวจสอบสถานะงานซ่อมได้อย่างรวดเร็วและมีประสิทธิภาพ</p>
                    </div>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-4">
                    <div id="userProfile" class="hidden items-center space-x-2 bg-white/10 rounded-full pl-2 pr-4 py-1">
                        <img id="userAvatar" class="w-8 h-8 rounded-full" src="" alt="User Avatar">
                        <span id="userName" class="font-medium"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Job Type Tabs -->
        <div class="flex overflow-x-auto scrollbar-hide mb-6 bg-white dark:bg-gray-800 rounded-lg shadow">
            <button class="job-type-tab active px-6 py-3 font-medium text-sm whitespace-nowrap" data-type="IT">
                <i class="fas fa-desktop mr-2"></i> งานซ่อม IT
            </button>
            <button class="job-type-tab px-6 py-3 font-medium text-sm whitespace-nowrap" data-type="EN">
                <i class="fas fa-cogs mr-2"></i> งานซ่อมเครื่องจักร
            </button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="glass-card flex flex-col items-center justify-center py-12 hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
            <p class="text-gray-700 dark:text-gray-300 font-medium">กำลังโหลดข้อมูล...</p>
        </div>

        <!-- Main Content Area -->
        <div id="mainContent" class="hidden">
            <!-- Dashboard Section -->
            <section id="dashboardSection" class="glass-card p-6 mb-8 animate-fade-in">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center">
                        <i class="fas fa-chart-pie mr-3 text-blue-500"></i>
                        ภาพรวมงานซ่อม
                    </h2>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mt-2 md:mt-0">
                        อัปเดตล่าสุด: <span id="lastUpdatedTime" class="font-semibold">กำลังโหลด...</span>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div class="stat-card bg-white dark:bg-gray-800 p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" data-status="all">
                        <div class="text-3xl font-bold text-blue-600 dark:text-blue-400 mb-1" id="totalJobsCount">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-300">ทั้งหมด</div>
                    </div>
                    <div class="stat-card bg-white dark:bg-gray-800 p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" data-status="new">
                        <div class="text-3xl font-bold text-blue-500 dark:text-blue-300 mb-1" id="newJobsCount">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-300">แจ้งซ่อมใหม่</div>
                    </div>
                    <div class="stat-card bg-white dark:bg-gray-800 p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" data-status="pending">
                        <div class="text-3xl font-bold text-orange-500 dark:text-orange-300 mb-1" id="pendingJobsCount">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-300">รอดำเนินการ</div>
                    </div>
                    <div class="stat-card bg-white dark:bg-gray-800 p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" data-status="in-progress">
                        <div class="text-3xl font-bold text-yellow-500 dark:text-yellow-300 mb-1" id="inProgressJobsCount">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-300">กำลังดำเนินการ</div>
                    </div>
                    <div class="stat-card bg-white dark:bg-gray-800 p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition-shadow" data-status="completed">
                        <div class="text-3xl font-bold text-green-500 dark:text-green-300 mb-1" id="completedJobsCount">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-300">เสร็จสิ้น</div>
                    </div>
                </div>

                <!-- Status Tabs
                <div class="flex overflow-x-auto scrollbar-hide border-b border-gray-200 dark:border-gray-700">
                    <button class="status-tab active px-4 py-2 font-medium text-sm whitespace-nowrap border-b-2 border-blue-500 text-blue-600 dark:text-blue-400" data-status="all">
                        ทั้งหมด
                    </button>
                    <button class="status-tab px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-status="new">
                        แจ้งซ่อมใหม่
                    </button>
                    <button class="status-tab px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-status="pending">
                        รอดำเนินการ
                    </button>
                    <button class="status-tab px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-status="in-progress">
                        กำลังดำเนินการ
                    </button>
                    <button class="status-tab px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-status="completed">
                        เสร็จสิ้น
                    </button>
                </div> -->
            </section>

            <!-- Job List and Details Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Job List Column -->
                <div class="lg:col-span-2 space-y-4">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                                รายการงานซ่อม (<span id="jobCount">0</span>)
                                <span class="text-sm font-normal ml-2" id="currentJobType">(IT)</span>
                            </h2>
                            <button id="refreshBtn" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search Box -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                        <div class="relative">
                            <input type="text" id="jobSearch" placeholder="ค้นหาจากเลขที่งาน, รายละเอียด..." 
                                   class="w-full px-4 py-3 border-0 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            <div class="absolute right-3 top-3 text-gray-400">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Jobs Container -->
                    <div id="jobsContainer" class="space-y-3"></div>
                    
                    <!-- No Jobs Found -->
                    <div id="noJobsFound" class="glass-card hidden">
                        <div class="text-center p-8">
                            <i class="fas fa-file-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600 dark:text-gray-300 font-medium">ไม่พบงานซ่อมในสถานะนี้</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">ลองเปลี่ยนสถานะหรือประเภทงานดูนะคะ</p>
                        </div>
                    </div>
                </div>

                <!-- Job Details Column -->
                <div class="lg:sticky lg:top-8 h-fit space-y-4">
                    <div id="detailHeader" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                            <span id="detailJobType" class="text-blue-600 dark:text-blue-400"></span> 
                            <span id="detailJobId" class="font-mono"></span>
                        </h3>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyDetails" class="glass-card">
                        <div class="text-center p-8">
                            <i class="fas fa-info-circle text-4xl text-blue-400 mb-4"></i>
                            <p class="text-gray-600 dark:text-gray-300 font-medium">เลือกงานจากรายการด้านซ้าย</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">รายละเอียดงานจะแสดงที่นี่</p>
                        </div>
                    </div>
                    
                    <!-- Job Details Container -->
                    <div id="jobDetailsContainer" class="glass-card hidden animate-fade-in"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Lightbox สำหรับดูรูปภาพแบบเต็มหน้าจอ -->
    <div id="lightbox" class="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="lightbox-nav">
            <button onclick="changeLightboxImage(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button onclick="changeLightboxImage(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <div class="lightbox-content">
            <img id="lightbox-image" src="" alt="">
        </div>
        
        <div class="lightbox-caption">
            <span id="lightbox-caption"></span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ค่าคงที่และตัวแปร
            const liffId = '2007374280-GR1Q3YxJ';
            const scriptUrl = 'https://script.google.com/macros/s/AKfycbzBBa2ZL8RMTw0UuNH89U8xYXF5xYRB-ek-ufJGem162kGOb7Fr2XqUfmalWp3q9nXQWA/exec';
            
            // ข้อมูลผู้ใช้
            let userId = '';
            let userDisplayName = '';
            let userPictureUrl = '';
            
            // ข้อมูลงานซ่อม
            let repairJobs = { IT: [], EN: [] };
            let filteredJobs = [];
            let selectedJobId = null;
            let currentStatusFilter = 'all';
            let currentJobType = 'IT';

            // Lightbox ตัวแปร
            let currentLightboxImages = [];
            let currentLightboxIndex = 0;

            // องค์ประกอบ DOM
            const loadingIndicator = document.getElementById('loadingIndicator');
            const mainContent = document.getElementById('mainContent');
            const jobsContainer = document.getElementById('jobsContainer');
            const noJobsFound = document.getElementById('noJobsFound');
            const jobDetailsContainer = document.getElementById('jobDetailsContainer');
            const emptyDetails = document.getElementById('emptyDetails');
            const detailHeader = document.getElementById('detailHeader');
            const jobSearch = document.getElementById('jobSearch');
            const refreshBtn = document.getElementById('refreshBtn');
            const backBtn = document.getElementById('backBtn');
            const themeToggle = document.getElementById('themeToggle');
            const userProfile = document.getElementById('userProfile');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const statCards = document.querySelectorAll('.stat-card');
            const statusTabs = document.querySelectorAll('.status-tab');
            const jobTypeTabs = document.querySelectorAll('.job-type-tab');

            // ตรวจสอบโหมดสี
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            /**
             * เริ่มต้น LIFF แอปพลิเคชัน
             */
            async function initializeLiff() {
                try {
                    await liff.init({ liffId });
                    
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }
                    
                    const profile = await liff.getProfile();
                    userId = profile.userId;
                    userDisplayName = profile.displayName;
                    userPictureUrl = profile.pictureUrl || '';
                    
                    // แสดงข้อมูลผู้ใช้
                    if (userPictureUrl) {
                        userAvatar.src = userPictureUrl;
                        userAvatar.alt = userDisplayName;
                    }
                    userName.textContent = userDisplayName;
                    userProfile.classList.remove('hidden');
                    
                    await loadRepairJobs();
                    
                } catch (error) {
                    console.error('LIFF initialization failed:', error);
                    showError('เกิดข้อผิดพลาดในการเชื่อมต่อ LINE LIFF', error.message);
                }
            }
            
            /**
             * แสดงข้อความผิดพลาด
             */
            function showError(title, message) {
                loadingIndicator.innerHTML = `
                    <div class="text-center p-6">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                        <h3 class="mt-3 text-lg font-medium text-gray-900 dark:text-white">${title}</h3>
                        <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                            ${message || 'กรุณาลองใหม่อีกครั้ง'}
                        </div>
                        <div class="mt-5">
                            <button onclick="window.location.reload()" 
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-sync-alt mr-2"></i> ลองใหม่
                            </button>
                        </div>
                    </div>
                `;
                loadingIndicator.classList.remove('hidden');
                mainContent.classList.add('hidden');
            }
            
            /**
             * แสดงการแจ้งเตือนด้วย SweetAlert2
             */
            function showAlert(icon, title, text, confirmButtonText = 'ตกลง') {
                return Swal.fire({
                    icon,
                    title,
                    text,
                    confirmButtonText,
                    confirmButtonColor: '#3B82F6',
                });
            }
            
            /**
             * โหลดข้อมูลงานซ่อม
             */
            async function loadRepairJobs() {
                try {
                    if (!userId) {
                        throw new Error('ไม่พบข้อมูลผู้ใช้');
                    }
                    
                    loadingIndicator.classList.remove('hidden');
                    mainContent.classList.add('hidden');
                    
                    const timestamp = new Date().getTime();
                    const [itResponse, enResponse] = await Promise.all([
                        fetch(`${scriptUrl}?action=getRepairJobs&userId=${encodeURIComponent(userId)}&formType=IT&t=${timestamp}`),
                        fetch(`${scriptUrl}?action=getRepairJobs&userId=${encodeURIComponent(userId)}&formType=EN&t=${timestamp}`)
                    ]);
                    
                    if (!itResponse.ok || !enResponse.ok) {
                        throw new Error(`การเชื่อมต่อกับเซิร์ฟเวอร์มีปัญหา: ${itResponse.status}`);
                    }
                    
                    const [itData, enData] = await Promise.all([
                        itResponse.json(),
                        enResponse.json()
                    ]);
                    
                    if (itData.status === 'error' || enData.status === 'error') {
                        throw new Error(itData.message || enData.message || 'เกิดข้อผิดพลาดในการดึงข้อมูล');
                    }
                    
                    // Process IT jobs
                    repairJobs.IT = (itData.data || []).map(job => {
                        return {
                            ...job,
                            // แปลงข้อมูลรูปภาพให้เป็น array
                            imageUrls: job.imageViewerUrls ? job.imageViewerUrls.split(',').map(url => url.trim()) : [],
                            driveUrls: job.googleDriveUrls ? job.googleDriveUrls.split(',').map(url => url.trim()) : []
                        };
                    });
                    
                    // Process EN jobs
                    repairJobs.EN = (enData.data || []).map(job => {
                        return {
                            ...job,
                            // รวมรูปภาพจากทุกคอลัมน์ที่อาจมีรูปภาพ
                            imageUrls: [
                                job.photo1,
                                job.photo2,
                                job.photo3
                            ].filter(url => url && url.trim() !== '')
                        };
                    });
                    
                    updateDashboardStats();
                    filterJobsByType(currentJobType);
                    
                    loadingIndicator.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    
                    document.getElementById('lastUpdatedTime').textContent = new Date().toLocaleString('th-TH', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                } catch (error) {
                    console.error('Error loading repair jobs:', error);
                    showError('โหลดข้อมูลงานซ่อมไม่สำเร็จ', error.message || 'กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');
                }
            }
            
            /**
             * อัปเดตสถิติแดชบอร์ด
             */
            function updateDashboardStats() {
                const jobs = repairJobs[currentJobType];
                const totalJobs = jobs.length;
                const newJobs = jobs.filter(job => job.status === 'แจ้งซ่อมใหม่').length;
                const pendingJobs = jobs.filter(job => job.status === 'รอดำเนินการ').length;
                const inProgressJobs = jobs.filter(job => job.status === 'กำลังดำเนินการ').length;
                const completedJobs = jobs.filter(job => job.status === 'เสร็จสิ้น').length;
                
                document.getElementById('totalJobsCount').textContent = totalJobs;
                document.getElementById('newJobsCount').textContent = newJobs;
                document.getElementById('pendingJobsCount').textContent = pendingJobs;
                document.getElementById('inProgressJobsCount').textContent = inProgressJobs;
                document.getElementById('completedJobsCount').textContent = completedJobs;
            }
            
            /**
             * กรองงานตามประเภท
             */
            function filterJobsByType(type) {
                currentJobType = type;
                document.getElementById('currentJobType').textContent = `(${type})`;
                document.body.classList.toggle('show-en', type === 'EN');
                
                jobTypeTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.type === type);
                });
                
                filterJobsByStatus(currentStatusFilter);
                updateDashboardStats();
            }
            
            /**
             * กรองงานตามสถานะ
             */
            function filterJobsByStatus(status) {
                currentStatusFilter = status;
                
                statusTabs.forEach(tab => {
                    tab.classList.toggle('border-blue-500', tab.dataset.status === status);
                    tab.classList.toggle('text-blue-600', tab.dataset.status === status);
                    tab.classList.toggle('dark:text-blue-400', tab.dataset.status === status);
                    tab.classList.toggle('text-gray-500', tab.dataset.status !== status);
                    tab.classList.toggle('dark:text-gray-400', tab.dataset.status !== status);
                });
                
                let jobs = [...repairJobs[currentJobType]];
                
                switch(status) {
                    case 'new':
                        jobs = jobs.filter(job => job.status === 'แจ้งซ่อมใหม่');
                        break;
                    case 'pending':
                        jobs = jobs.filter(job => job.status === 'รอดำเนินการ');
                        break;
                    case 'in-progress':
                        jobs = jobs.filter(job => job.status === 'กำลังดำเนินการ');
                        break;
                    case 'completed':
                        jobs = jobs.filter(job => job.status === 'เสร็จสิ้น');
                        break;
                }
                
                filteredJobs = jobs;
                renderJobList();
                
                if (selectedJobId && !filteredJobs.some(job => job.jobId === selectedJobId)) {
                    selectedJobId = null;
                    jobDetailsContainer.classList.add('hidden');
                    emptyDetails.classList.remove('hidden');
                    detailHeader.classList.add('hidden');
                }
                
                checkNoJobsFound();
            }
            
            /**
             * ตรวจสอบว่ามีงานที่พบหรือไม่
             */
            function checkNoJobsFound() {
                const hasJobs = filteredJobs.length > 0;
                noJobsFound.classList.toggle('hidden', hasJobs);
                jobsContainer.classList.toggle('hidden', !hasJobs);
            }
            
            /**
             * แสดงรายการงานซ่อม
             */
            function renderJobList() {
                jobsContainer.innerHTML = '';
                document.getElementById('jobCount').textContent = filteredJobs.length;
                
                if (filteredJobs.length === 0) {
                    checkNoJobsFound();
                    return;
                }
                
                filteredJobs.forEach((job, index) => {
                    const jobCard = document.createElement('div');
                    jobCard.className = `bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden cursor-pointer transition-all duration-200 hover:shadow-md ${selectedJobId === job.jobId ? 'ring-2 ring-blue-500' : ''}`;
                    jobCard.id = `job-${job.jobId}`;
                    jobCard.onclick = () => selectJob(job.jobId);
                    
                    const statusInfo = getStatusInfo(job.status);
                    const priorityInfo = getPriorityInfo(job.urgency);
                    const problemInfo = currentJobType === 'IT' 
                        ? job.problemType || 'ไม่ระบุประเภทปัญหา'
                        : job.machineName ? `${job.machineName} (${job.jobType || 'ไม่ระบุ'})` : job.jobType || 'ไม่ระบุประเภทงาน';
                    
                    jobCard.innerHTML = `
                        <div class="p-4">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white truncate">${job.jobId || 'N/A'}</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mt-1 truncate">${problemInfo}</p>
                                </div>
                                <div class="ml-4 flex flex-col items-end">
                                    <span class="${statusInfo.class} mb-1">
                                        <i class="${statusInfo.icon} mr-1"></i>
                                        ${statusInfo.text}
                                    </span>
                                    ${priorityInfo ? `
                                        <span class="${priorityInfo.class}">
                                            ${priorityInfo.text}
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div class="mt-4 flex items-center justify-between text-sm text-gray-500 dark:text-gray-400">
                                <div class="flex items-center">
                                    <i class="fas fa-user-circle mr-2"></i>
                                    <span>${job.fullName || 'ไม่ระบุชื่อ'}</span> -
                                    (<span>${job.department || 'ไม่ระบุแผนก'}</span>)
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-calendar-alt mr-2"></i>
                                    <span>${formatDate(job.timestamp)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    jobsContainer.appendChild(jobCard);
                });
            }
            
            /**
             * เลือกงานเพื่อดูรายละเอียด
             */
            function selectJob(jobId) {
                const selectedJob = filteredJobs.find(job => job.jobId === jobId);
                if (!selectedJob) return;
                
                document.querySelectorAll('#jobsContainer > div').forEach(card => {
                    card.classList.remove('ring-2', 'ring-blue-500');
                });
                
                const currentSelectedCard = document.getElementById(`job-${jobId}`);
                if (currentSelectedCard) {
                    currentSelectedCard.classList.add('ring-2', 'ring-blue-500');
                }

                selectedJobId = jobId;
                renderJobDetails(selectedJob);
            }
            
            /**
             * แสดงรายละเอียดงาน
             */
            function renderJobDetails(job) {
                emptyDetails.classList.add('hidden');
                detailHeader.classList.remove('hidden');
                jobDetailsContainer.classList.remove('hidden');
                
                document.getElementById('detailJobType').textContent = currentJobType;
                document.getElementById('detailJobId').textContent = job.jobId || 'N/A';
                
                jobDetailsContainer.innerHTML = `
                    <div class="p-6 space-y-6">
                        ${createStatusSummaryHtml(job)}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">ผู้แจ้งซ่อม</p>
                                <p class="font-medium text-gray-900 dark:text-white">${job.fullName || 'ไม่ระบุ'}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-300">${job.department || 'ไม่ระบุแผนก'}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">วันที่แจ้งซ่อม</p>
                                <p class="font-medium text-gray-900 dark:text-white">${formatThaiDate(job.timestamp)}</p>
                            </div>
                        </div>
                        
                        ${createTypeSpecificHtml(job)}
                        
                        ${createFileAttachmentsHtml(job)}
                        
                        ${createProgressNotesHtml(job)}
                        
                        ${job.additionalNotes ? `
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg border border-yellow-200 dark:border-yellow-800">
                                <h4 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">หมายเหตุเพิ่มเติม</h4>
                                <p class="text-sm text-yellow-700 dark:text-yellow-300">${job.additionalNotes}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            /**
             * สร้าง HTML สำหรับสรุปสถานะงาน
             */
            function createStatusSummaryHtml(job) {
                const statusInfo = getStatusInfo(job.status);
                const priorityInfo = getPriorityInfo(job.urgency || job.priority);
                
                return `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">สถานะงาน</p>
                            <div class="flex items-center">
                                <i class="${statusInfo.icon} mr-2 text-${statusInfo.color}-500 dark:text-${statusInfo.color}-400"></i>
                                <span class="font-medium text-gray-900 dark:text-white">${statusInfo.text}</span>
                            </div>
                        </div>
                        ${priorityInfo ? `
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">ความเร่งด่วน</p>
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-circle mr-2 text-${priorityInfo.color}-500 dark:text-${priorityInfo.color}-400"></i>
                                    <span class="font-medium text-gray-900 dark:text-white">${priorityInfo.text}</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            /**
             * สร้าง HTML สำหรับข้อมูลเฉพาะประเภทงาน
             */
            function createTypeSpecificHtml(job) {
                if (currentJobType === 'IT') {
                    return `
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">ข้อมูลปัญหา</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">ประเภทปัญหา</p>
                                    <p class="text-gray-900 dark:text-white">${job.problemType || 'ไม่ระบุ'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">อุปกรณ์</p>
                                    <p class="text-gray-900 dark:text-white">${job.device || 'ไม่ระบุ'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">ความเร่งด่วน</p>
                                    <p class="text-gray-900 dark:text-white">${job.urgency || 'ไม่ระบุ'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">สำนักงาน</p>
                                    <p class="text-gray-900 dark:text-white">${job.office || 'ไม่ระบุ'}</p>
                                </div>
                            </div>
                            <div class="mt-4">
                                <p class="text-sm text-gray-500 dark:text-gray-400">รายละเอียดปัญหา</p>
                                <p class="text-gray-900 dark:text-white mt-1">${job.problemDetails || 'ไม่มีรายละเอียดเพิ่มเติม'}</p>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="space-y-6">
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">ข้อมูลเครื่องจักร</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">ชื่อเครื่องจักร</p>
                                        <p class="text-gray-900 dark:text-white">${job.machineName || 'ไม่ระบุ'}</p>
                                    </div>

                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">ประเภทงาน</p>
                                        <p class="text-gray-900 dark:text-white">${job.jobType || 'ไม่ระบุ'}</p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">รายละเอียดปัญหา</p>
                                    <p class="text-gray-900 dark:text-white mt-1">${job.problemDescription || 'ไม่มีรายละเอียด'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow en-specific">
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">การซ่อมบำรุง</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">ผู้ตรวจพบปัญหา</p>
                                        <p class="text-gray-900 dark:text-white">${job.fullName || 'ไม่ระบุ'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">วันที่พบปัญหา</p>
                                        <p class="text-gray-900 dark:text-white">${formatDate(job.timestamp) || 'ไม่ระบุ'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">สาเหตุ</p>
                                        <p class="text-gray-900 dark:text-white">${job.rootCause || 'ยังไม่ทราบสาเหตุ'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">การดำเนินการ</p>
                                        <p class="text-gray-900 dark:text-white">${job.maintenanceAction || 'ไม่ระบุ'}</p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">รายละเอียดการซ่อม</p>
                                    <p class="text-gray-900 dark:text-white mt-1">${job.maintenanceDescription || 'ไม่มีข้อมูล'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow en-specific">
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">อะไหล่และวัสดุ</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">อะไหล่ที่ใช้</p>
                                        <p class="text-gray-900 dark:text-white">${job.sparePartsUsed || 'ไม่มี'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">จำนวน</p>
                                        <p class="text-gray-900 dark:text-white">${job.quantity || '0'} ${job.unit || 'ชิ้น'}</p>
                                    </div>
                                
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">ค่าใช้จ่าย</p>
                                        <p class="text-gray-900 dark:text-white">${job.cost ? '฿' + job.cost : 'ไม่ระบุ'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
      function createFileAttachmentsHtml(job) {
    let fileUrls = [];

    // **** สำคัญ: currentJobType ต้องถูกกำหนดค่าไว้ก่อนเรียกใช้ฟังก์ชันนี้ ****
    // ตัวอย่าง: ถ้า currentJobType เป็น Global variable, หรือถูกส่งมาพร้อม job
    // เช่น: const currentJobType = job.type; // ถ้า job มี property ชื่อ 'type'
    // หากไม่มีการกำหนด 'currentJobType' คุณอาจต้องกำหนดค่าเริ่มต้นให้มัน
    // เช่น: const currentJobType = window.currentJobType || 'EN'; // สำหรับการใช้งานในเบราว์เซอร์

    // ฟังก์ชันย่อยสำหรับแปลงลิงก์ Google Drive
    function _getDirectDriveImageUrl(driveUrl) {
        if (!driveUrl) return null;

        // ข้ามลิงก์รูปโปรไฟล์ Google ทันที
        if (driveUrl.includes('googleusercontent.com/profile/picture')) {
            // console.warn(`Skipping Google Profile Picture URL: ${driveUrl}`); // สามารถเปิด console.warn ได้ถ้าต้องการ log
            return null;
        }

        let fileId = null;
        // พยายามดึง FILE_ID จากรูปแบบ URL ต่างๆ ของ Google Drive
        const viewUrlMatch = driveUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)\/view/);
        if (viewUrlMatch && viewUrlMatch[1]) {
            fileId = viewUrlMatch[1];
        } else {
            const idMatch = driveUrl.match(/id=([a-zA-Z0-9_-]+)/);
            if (idMatch && idMatch[1]) {
                fileId = idMatch[1];
            } else {
                const shortUrlMatch = driveUrl.match(/drive.google.com\/(?:file\/d\/|open\?id=)([a-zA-Z0-9_-]+)/);
                if (shortUrlMatch && shortUrlMatch[1]) {
                    fileId = shortUrlMatch[1];
                }
            }
        }

        if (fileId) {
            return `https://drive.google.com/uc?export=view&id=${fileId}`;
        }

        // console.warn(`Could not extract file ID from Drive URL: ${driveUrl}`); // สามารถเปิด console.warn ได้ถ้าต้องการ log
        return null; // ไม่สามารถดึง ID ได้
    }

    if (currentJobType === 'IT') {
        // สำหรับงาน IT: รวมทั้ง imageUrls และ driveUrls
        // ประมวลผล driveUrls ด้วยฟังก์ชัน _getDirectDriveImageUrl
        const processedDriveUrls = (job.driveUrls || [])
            .map(url => _getDirectDriveImageUrl(url))
            .filter(url => url !== null); // กรองเอาเฉพาะลิงก์ที่แปลงได้สำเร็จ

        fileUrls = [...(job.imageUrls || []), ...processedDriveUrls];
    } else {
        // สำหรับงาน EN: รวมรูปภาพจากทุกคอลัมน์
        fileUrls = job.imageUrls || [];
    }

    // กรอง URL ที่ไม่ถูกต้องออกและเอาค่าซ้ำออก
    const validUrls = fileUrls
        .filter(url => url && (url.startsWith('http://') || url.startsWith('https://')))
        .filter((url, index, self) => self.indexOf(url) === index); // ลบ URL ซ้ำ

    if (validUrls.length === 0) {
        return `
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">ไฟล์แนบประกอบ</h4>
                <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-paperclip text-3xl mb-2"></i>
                    <p>ไม่มีไฟล์แนบ</p>
                </div>
            </div>
        `;
    }

    // แยก URL รูปภาพออกมาต่างหากสำหรับแกลเลอรีภาพขยาย
    const imageUrls = validUrls.filter(url => url.match(/\.(jpeg|jpg|gif|png|webp|bmp)$/i));

    return `
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">ไฟล์แนบประกอบ (${validUrls.length})</h4>
            
            <div class="mb-4">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                    ${validUrls.map((url, index) => {
                        const isImage = url.match(/\.(jpeg|jpg|gif|png|webp|bmp)$/i) !== null;
                        const fileName = url.split('/').pop() || `ไฟล์ ${index + 1}`;
                        const fileExtension = fileName.split('.').pop().toLowerCase();
                        
                        // กำหนด class ไอคอนสำหรับไฟล์ที่ไม่ใช่รูปภาพ
                        let iconClass = 'fas fa-file file-icon-default';
                        if (fileExtension === 'pdf') iconClass = 'fas fa-file-pdf pdf-icon';
                        else if (['doc', 'docx'].includes(fileExtension)) iconClass = 'fas fa-file-word doc-icon';
                        else if (['xls', 'xlsx', 'csv'].includes(fileExtension)) iconClass = 'fas fa-file-excel xls-icon';
                        else if (['ppt', 'pptx'].includes(fileExtension)) iconClass = 'fas fa-file-powerpoint ppt-icon';
                        else if (['zip', 'rar', '7z'].includes(fileExtension)) iconClass = 'fas fa-file-archive zip-icon';
                        else if (['mp4', 'mov', 'avi', 'mkv'].includes(fileExtension)) iconClass = 'fas fa-file-video video-icon';
                        else if (['mp3', 'wav', 'ogg'].includes(fileExtension)) iconClass = 'fas fa-file-audio audio-icon';
                        
                        return `
                            <a href="${url}" target="_blank" 
                               class="group block border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-200 relative"
                               title="${fileName}">
                                <div class="relative pt-[100%] bg-gray-100 dark:bg-gray-700">
                                    ${isImage ? `
                                        <img src="${url}" alt="ไฟล์แนบ" 
                                            class="absolute top-0 left-0 w-full h-full object-cover"
                                            onerror="this.onerror=null;this.src='https://via.placeholder.com/150?text=Image+Not+Found'">
                                    ` : `
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <i class="${iconClass} file-icon text-4xl text-gray-500 dark:text-gray-400"></i>
                                        </div>
                                    `}
                                </div>
                                <div class="p-2 bg-white dark:bg-gray-800">
                                    <p class="text-xs text-gray-600 dark:text-gray-300 truncate">${fileName}</p>
                                </div>
                                ${isImage ? `
                                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                        <i class="fas fa-expand text-white text-xl"></i>
                                    </div>
                                ` : ''}
                            </a>
                        `;
                    }).join('')}
                </div>
            </div>
            
            ${imageUrls.length > 0 ? `
                <div class="mt-6">
                    <h5 class="text-md font-semibold text-gray-800 dark:text-gray-200 mb-3">รูปภาพทั้งหมด (ภาพขยาย)</h5>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${imageUrls.map((url, index) => `
                            <div class="relative group cursor-pointer" onclick="openLightbox(imageUrls, ${index})">
                                <img src="${url}" alt="รูปภาพประกอบงานซ่อม" 
                                    class="w-full h-48 object-cover rounded-lg shadow"
                                    onerror="this.onerror=null;this.src='https://via.placeholder.com/400?text=Image+Not+Found'">
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                    <i class="fas fa-expand text-white text-xl"></i>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}
       
            /**
             * สร้าง HTML สำหรับบันทึกความคืบหน้า
             */
            function createProgressNotesHtml(job) {
                let notes = job.notes || job.maintenanceNote || job.progressNotes || '';
                
                if (currentJobType === 'EN' && job.historyNotes) {
                    notes = job.historyNotes;
                }
                
                if (!notes || notes.length === 0) {
                    return `
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">บันทึกความคืบหน้า</h4>
                            <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle text-3xl mb-2"></i>
                                <p>ยังไม่มีบันทึกความคืบหน้า</p>
                            </div>
                        </div>
                    `;
                }
                
                const notesArray = typeof notes === 'string' ? notes.split('\n').filter(n => n.trim().length > 0) : notes;
                
                return `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">บันทึกความคืบหน้า (${notesArray.length})</h4>
                        <div class="space-y-3">
                            ${notesArray.map((note, index) => `
                                <div class="flex items-start space-x-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
                                        <span class="text-blue-600 dark:text-blue-300 font-medium text-sm">${index + 1}</span>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm text-gray-800 dark:text-gray-200">${note}</p>
                                        ${job.noteDates && job.noteDates[index] ? `
                                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                                <i class="far fa-clock mr-1"></i>
                                                ${formatDateTime(job.noteDates[index])}
                                            </p>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            /**
             * ข้อมูลสถานะงาน
             */
            function getStatusInfo(status) {
                switch(status) {
                    case 'แจ้งซ่อมใหม่':
                        return { class: 'status-new', icon: 'fas fa-file-circle-plus text-blue-500', text: 'แจ้งซ่อมใหม่', color: 'blue' };
                    case 'รอดำเนินการ':
                        return { class: 'status-pending', icon: 'fas fa-clock text-orange-500', text: 'รอดำเนินการ', color: 'orange' };
                    case 'กำลังดำเนินการ':
                        return { class: 'status-in-progress', icon: 'fas fa-tools text-yellow-500', text: 'กำลังดำเนินการ', color: 'yellow' };
                    case 'เสร็จสิ้น':
                        return { class: 'status-completed', icon: 'fas fa-check-circle text-green-500', text: 'เสร็จสิ้น', color: 'green' };
                    case 'ยกเลิก':
                        return { class: 'status-cancelled', icon: 'fas fa-times-circle text-gray-500', text: 'ยกเลิก', color: 'gray' };
                    default:
                        return { class: 'status-pending', icon: 'fas fa-clock text-gray-500', text: status || 'ไม่ทราบสถานะ', color: 'gray' };
                }
            }
            
            /**
             * ข้อมูลความเร่งด่วน
             */
            function getPriorityInfo(priority) {
                if (!priority) return null;
                
                switch(priority.toLowerCase()) {
                    case 'ต่ำ':
                        return { class: 'priority-low', text: 'ต่ำ', color: 'gray' };
                    case 'ปานกลาง':
                    case 'normal':
                        return { class: 'priority-medium', text: 'ปานกลาง', color: 'blue' };
                    case 'สูง':
                    case 'high':
                        return { class: 'priority-high', text: 'สูง', color: 'orange' };
                    case 'ด่วนมาก':
                    case 'critical':
                        return { class: 'priority-critical', text: 'ด่วนมาก', color: 'red' };
                    default:
                        return { class: 'priority-medium', text: priority, color: 'blue' };
                }
            }
            
            /**
             * จัดรูปแบบวันที่
             */
            function formatDate(dateString) {
                if (!dateString) return 'ไม่ระบุ';
                
                const date = convertGoogleDate(dateString);
                if (isNaN(date.getTime())) return 'ไม่ระบุ';
                
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            /**
             * จัดรูปแบบวันที่ภาษาไทย
             */
            function formatThaiDate(dateString) {
                if (!dateString) return 'ไม่ระบุ';
                
                const date = convertGoogleDate(dateString);
                if (isNaN(date.getTime())) return 'ไม่ระบุ';
                
                const thaiMonths = [
                    'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน',
                    'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม',
                    'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
                ];
                
                const day = date.getDate();
                const month = thaiMonths[date.getMonth()];
                const year = date.getFullYear() + 543;
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                
                return `${day} ${month} ${year} ${hours}:${minutes} น.`;
            }
            
            /**
             * จัดรูปแบบวันที่และเวลา
             */
            function formatDateTime(dateTimeString) {
                if (!dateTimeString) return 'ไม่ระบุ';
                
                const date = convertGoogleDate(dateTimeString);
                if (isNaN(date.getTime())) return 'ไม่ระบุ';
                
                return date.toLocaleString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }
            
            /**
             * แปลงรูปแบบวันที่จาก Google Sheets
             */
            function convertGoogleDate(dateString) {
                if (!dateString) return new Date(NaN);
                
                // ถ้าเป็น timestamp
                if (typeof dateString === 'number') {
                    return new Date(dateString);
                }
                
                // ถ้าเป็น string ที่มีรูปแบบวันที่
                if (typeof dateString === 'string') {
                    // รูปแบบ yyyy-mm-dd
                    const isoFormat = dateString.match(/^(\d{4})-(\d{2})-(\d{2})/);
                    if (isoFormat) {
                        return new Date(Date.UTC(
                            parseInt(isoFormat[1]),
                            parseInt(isoFormat[2]) - 1,
                            parseInt(isoFormat[3])
                        ));
                    }
                    
                    // รูปแบบ dd/mm/yyyy
                    const slashFormat = dateString.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
                    if (slashFormat) {
                        return new Date(
                            parseInt(slashFormat[3]),
                            parseInt(slashFormat[2]) - 1,
                            parseInt(slashFormat[1])
                        );
                    }
                    
                    // ลองแปลงเป็น Date object ตรงๆ
                    const parsedDate = new Date(dateString);
                    if (!isNaN(parsedDate.getTime())) {
                        return parsedDate;
                    }
                }
                
                return new Date(NaN);
            }
            
            /**
             * เปิด Lightbox สำหรับดูรูปภาพ
             */
            function openLightbox(images, startIndex = 0) {
                if (!images || images.length === 0) return;
                
                currentLightboxImages = images;
                currentLightboxIndex = startIndex;
                
                const lightbox = document.getElementById('lightbox');
                const lightboxImage = document.getElementById('lightbox-image');
                const lightboxCaption = document.getElementById('lightbox-caption');
                
                lightboxImage.src = images[startIndex];
                lightboxCaption.textContent = `รูปภาพ ${startIndex + 1} จาก ${images.length}`;
                
                lightbox.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            
            /**
             * ปิด Lightbox
             */
            function closeLightbox() {
                document.getElementById('lightbox').style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            
            /**
             * เปลี่ยนรูปภาพใน Lightbox
             */
            function changeLightboxImage(step) {
                currentLightboxIndex += step;
                
                // Handle wrap-around
                if (currentLightboxIndex >= currentLightboxImages.length) {
                    currentLightboxIndex = 0;
                } else if (currentLightboxIndex < 0) {
                    currentLightboxIndex = currentLightboxImages.length - 1;
                }
                
                const lightboxImage = document.getElementById('lightbox-image');
                const lightboxCaption = document.getElementById('lightbox-caption');
                
                lightboxImage.src = currentLightboxImages[currentLightboxIndex];
                lightboxCaption.textContent = `รูปภาพ ${currentLightboxIndex + 1} จาก ${currentLightboxImages.length}`;
            }
            
            /**
             * ตั้งค่าการค้นหา
             */
            function setupSearch() {
                jobSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    
                    if (searchTerm === '') {
                        filterJobsByStatus(currentStatusFilter);
                        return;
                    }
                    
                    filteredJobs = repairJobs[currentJobType].filter(job => {
                        return (
                            (job.jobId && job.jobId.toLowerCase().includes(searchTerm)) ||
                            (job.problemDetails && job.problemDetails.toLowerCase().includes(searchTerm)) ||
                            (job.problemDescription && job.problemDescription.toLowerCase().includes(searchTerm)) ||
                            (job.machineName && job.machineName.toLowerCase().includes(searchTerm)) ||
                            (job.problemType && job.problemType.toLowerCase().includes(searchTerm)) ||
                            (job.jobType && job.jobType.toLowerCase().includes(searchTerm))
                        );
                    });
                    
                    renderJobList();
                    checkNoJobsFound();
                });
            }
            
            /**
             * กลับไปหน้าก่อนหน้า
             */
            function goBack() {
                if (liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.location.href = 'https://liff.line.me/2007374280-GEYwyNdl';
                }
            }
            
            /**
             * สลับโหมดสี
             */
            function toggleDarkMode() {
                if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                }
            }
            
            // ตั้งค่า Event Listeners
            statCards.forEach(card => {
                card.addEventListener('click', function() {
                    filterJobsByStatus(this.dataset.status);
                });
            });
            
            statusTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    filterJobsByStatus(this.dataset.status);
                });
            });
            
            jobTypeTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    filterJobsByType(this.dataset.type);
                });
            });
            
            refreshBtn.addEventListener('click', function() {
                loadRepairJobs();
                showAlert('success', 'กำลังโหลดข้อมูล', 'ระบบกำลังอัปเดตข้อมูลงานซ่อมล่าสุด');
            });
            
            backBtn.addEventListener('click', goBack);
            themeToggle.addEventListener('click', toggleDarkMode);
            
            // เปิด Lightbox จาก global scope
            window.openLightbox = openLightbox;
            window.closeLightbox = closeLightbox;
            window.changeLightboxImage = changeLightboxImage;
            
            // เริ่มต้นแอปพลิเคชัน
            window.onload = function() {
                initializeLiff();
                setupSearch();
        });
    </script>
</body>
</html>
