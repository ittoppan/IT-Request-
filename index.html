<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>แจ้งซ่อม (LIFF + LINE Login)</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    form { max-width: 400px; }
    input, textarea, button { width: 100%; padding: 8px; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>แบบฟอร์มแจ้งซ่อม</h2>

  <div id="loading">กำลังตรวจสอบ LINE login…</div>

  <form id="repairForm" style="display: none;">
    <input type="hidden" id="userId">
    <label>ชื่อผู้แจ้ง:</label>
    <input type="text" id="name" required>

    <label>รายละเอียด:</label>
    <textarea id="detail" rows="4" required></textarea>

    <button type="submit">ส่งแจ้งซ่อม</button>
  </form>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbx064XcS9rmptTMy-oeJDpz2kyyFIxEHYIkO7ucbQCmfit56HlkmgTPFohcUUIL-tpVGQ/exec";
    const liffId = "2007374280-GEYwyNdl";
    const clientId = "2007374280";
    const clientSecret = "740c0adfbd2777f96ab1e67f50ef5635";
    const redirectUri = window.location.origin + window.location.pathname;

    function showForm(userId) {
      document.getElementById("loading").style.display = "none";
      document.getElementById("userId").value = userId;
      document.getElementById("repairForm").style.display = "block";
    }

    async function initLIFF() {
      await liff.init({ liffId });
      if (!liff.isLoggedIn()) return liff.login();
      const profile = await liff.getProfile();
      showForm(profile.userId);
    }

    async function initWebLogin() {
      const params = new URLSearchParams(location.search);
      const code = params.get("code");
      if (!code) {
        const authUrl = `https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&state=xyz123&scope=profile%20openid&nonce=abc123`;
        return window.location.href = authUrl;
      }
      const resToken = await fetch("https://api.line.me/oauth2/v2.1/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          grant_type: "authorization_code",
          code, redirect_uri: redirectUri,
          client_id: clientId, client_secret: clientSecret
        })
      });
      const token = await resToken.json();
      const resProfile = await fetch("https://api.line.me/v2/profile", {
        headers: { Authorization: "Bearer " + token.access_token }
      });
      const profile = await resProfile.json();
      showForm(profile.userId);
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (navigator.userAgent.includes("Line")) {
        initLIFF();
      } else {
        initWebLogin();
      }

      document.getElementById("repairForm").addEventListener("submit", async e => {
        e.preventDefault();
        const data = {
          userId: document.getElementById("userId").value,
          name: document.getElementById("name").value,
          detail: document.getElementById("detail").value
        };
        await fetch(scriptUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        alert("ส่งแจ้งซ่อมเรียบร้อยครับ!");
        if (navigator.userAgent.includes("Line")) liff.closeWindow();
        else window.location.href = "/";
      });
    });
  </script>
</body>
</html>
