<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>แบบฟอร์มแจ้งซ่อม IT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="p-4 bg-gray-100">
  <form id="repairForm" class="space-y-4 bg-white p-6 rounded-lg shadow max-w-xl mx-auto">
    <input type="hidden" id="lineUserId" name="lineUserId">
    <input type="hidden" id="lineDisplayName" name="lineDisplayName">
    <input type="hidden" id="linePictureUrl" name="linePictureUrl">

    <div>
      <label>ชื่อ-นามสกุล</label>
      <input type="text" name="fullName" required class="w-full border p-2 rounded">
    </div>

    <div>
      <label>แผนก</label>
      <input type="text" name="department" required class="w-full border p-2 rounded">
    </div>

    <div>
      <label>สำนักงาน</label>
      <select name="office" required class="w-full border p-2 rounded">
        <option value="">เลือกสำนักงาน</option>
        <option value="สำนักงานรังสิต">สำนักงานรังสิต</option>
        <option value="สำนักงานระยอง">สำนักงานระยอง</option>
      </select>
    </div>

    <div>
      <label>เบอร์ติดต่อ</label>
      <input type="tel" name="phone" required class="w-full border p-2 rounded">
    </div>

    <div>
      <label>อีเมล</label>
      <input type="email" name="email" class="w-full border p-2 rounded">
    </div>

    <div>
      <label>ประเภทปัญหา</label>
      <select name="problemType" required class="w-full border p-2 rounded">
        <option value="">เลือกประเภท</option>
        <option value="hardware">ฮาร์ดแวร์</option>
        <option value="software">ซอฟต์แวร์</option>
        <option value="network">เครือข่าย</option>
        <option value="email">อีเมล</option>
        <option value="printer">เครื่องพิมพ์</option>
        <option value="other">อื่น ๆ</option>
      </select>
    </div>

    <div>
      <label>รายละเอียดปัญหา</label>
      <textarea name="problemDetails" rows="4" class="w-full border p-2 rounded" required></textarea>
    </div>

    <div>
      <label>ระดับความเร่งด่วน</label><br>
      <label><input type="radio" name="urgency" value="low" checked> ปกติ</label>
      <label><input type="radio" name="urgency" value="medium"> ปานกลาง</label>
      <label><input type="radio" name="urgency" value="high"> ด่วน</label>
    </div>

    <div>
      <label>แนบไฟล์ (PNG, JPG, PDF):</label>
      <input type="file" id="fileInput" multiple accept="image/*,.pdf">
    </div>

    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">ส่งแบบฟอร์ม</button>
  </form>

<script>
const liffId = "2007374280-GEYwyNdl"; // ใส่ LIFF ID ของคุณ
const googleAppsScriptUrl = "https://script.google.com/macros/s/AKfycbzBBa2ZL8RMTw0UuNH89U8xYXF5xYRB-ek-ufJGem162kGOb7Fr2XqUfmalWp3q9nXQWA/exec";

async function getBase64Files(files) {
  const fileArray = Array.from(files);
  return await Promise.all(fileArray.map(file => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve({
        name: file.name,
        type: file.type,
        data: reader.result.split(',')[1]
      });
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }));
}

document.getElementById('repairForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const files = await getBase64Files(document.getElementById('fileInput').files);

  const payload = {
    lineUserId: formData.get("lineUserId"),
    lineDisplayName: formData.get("lineDisplayName"),
    linePictureUrl: formData.get("linePictureUrl"),
    fullName: formData.get("fullName"),
    department: formData.get("department"),
    office: formData.get("office"),
    phone: formData.get("phone"),
    email: formData.get("email"),
    problemType: formData.get("problemType"),
    problemDetails: formData.get("problemDetails"),
    urgency: formData.get("urgency"),
    files: files
  };

  Swal.fire({ title: "กำลังส่ง...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  fetch(googleAppsScriptUrl, {
    method: "POST",
    body: JSON.stringify(payload),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.json())
  .then(res => {
    Swal.close();
    if (res.status === "success") {
      Swal.fire("ส่งสำเร็จ", "ข้อมูลถูกส่งเรียบร้อยแล้ว", "success");
      form.reset();
    } else {
      throw new Error(res.message);
    }
  })
  .catch(err => {
    Swal.fire("เกิดข้อผิดพลาด", err.message, "error");
  });
});

document.addEventListener("DOMContentLoaded", async () => {
  await liff.init({ liffId });
  if (!liff.isLoggedIn()) return liff.login();

  const profile = await liff.getProfile();
  document.getElementById("lineUserId").value = profile.userId;
  document.getElementById("lineDisplayName").value = profile.displayName;
  document.getElementById("linePictureUrl").value = profile.pictureUrl || "";
});
</script>
</body>
</html>
